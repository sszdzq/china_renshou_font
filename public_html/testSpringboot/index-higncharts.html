<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<!--导入jquery文件-->
		<script src="./jquery/jquery.js" type="text/javascript"></script>
		<script src="../shared/js/jquery.extend.min.js" type="text/javascript"></script>
		<script src="../shared/js/myLayer.js" type="text/javascript"></script>
		<script src="../shared/layer/layer.js" type="text/javascript"></script>
		<!--导入bootstrap.css文件-->
		<link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css"  type="text/css" />
		<link rel="stylesheet" href="../shared/css/index-ess.css"  type="text/css" />
		<link rel="stylesheet" href="../shared/css/font-awesome.min.css"  type="text/css" />	
		<!--导入bootstrap.js文件-->
		<script type="text/javascript" src="./bootstrap/js/bootstrap.min.js" ></script>
		<!--创建视口-->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- jqgridjs -->
		<script src="../shared/jqgrid/js/jquery.jqGrid.src.js" type="text/javascript"></script>
		<script src="./jquery.jqGrid.extend.js" type="text/javascript"></script>
		<script type="text/javascript" src="../shared/jqgrid/js/i18n/grid.locale-cn.js"></script>
		<!-- highchart组件 -->
		<script src="../shared/highcharts/highcharts.js" type="text/javascript"></script>
		<script src="../shared/highcharts/highcharts-3d.js" type="text/javascript"></script>
		<script src="../shared/highcharts/highcharts-more.js" type="text/javascript"></script>
		<script src="../shared/highcharts/modules/exporting.js" type="text/javascript"></script>
	</head>
	<body>
		<!--创建布局容器-->
		<div class="container-fluid" style="margin:0 10px 0 10px;">
			<div class="clearfix"></div>
				<div class="row" style="margin-top:30px;font-size:18px;background:white;">
					<div class="col-md-3 col-sm-3 col-xs-6 text-center" style="height:200px;border:1px solid #E9E9E9";>
						<img src="../shared/images/assets/headPortrait/Fruit-2.png" width=110 height=110 style="margin-top:30px"/>
						<p id="usernameP"></p>
					</div>
					<div class="col-md-5 col-sm-5 col-xs-6 text-left" style="height:200px;border:1px solid #E9E9E9">
						<p id="departmentP" class="fa" style="margin-top:40px"></p>
						<p id="roleNameP" style="margin-top:15px"></p>
						<p id="lastLoginTimeP" style="margin-top:15px"></p>
					</div>
					<div class="col-md-4 col-sm-4 col-xs-6 text-left" style="height:200px;border:1px solid #E9E9E9">
						<p id="emailP" style="margin-top:40px"></p>
						<p id="mobileP" style="margin-top:15px"></p>
						<p id="workTelephoneP" style="margin-top:15px"></p>
					</div>
								
				
				</div>
				<div class="row" style="margin-top:40px;background:white;" >						
					<div class="col-md-3 col-sm-4 col-xs-6 text-center" style="height:400px;margin-left;border-right:25px solid #F5F5F5">
						<img src="../shared/images/assets/images/dashboard_seal_blue.png" width=120 height=120 style="margin-top:100px"/>
						<p style="font-size:18px;margin-top:58px;">
							<b><a href="#" style="color:black;">印模管理<span id="moulageCountSpan" style="color:blue;margin:0 15px 0 15px"></span>个</a></b>
						</p>
					</div>
					<div class="col-md-3 col-sm-4 col-xs-6 text-center" style="height:400px;padding:0 30px 0 30px;border-left:5px solid #F5F5F5;border-right:20px solid #F5F5F5;">
						<img src="../shared/images/assets/images/dashboard_seal_green.png" width=120 height=120 style="margin-top:100px;"/>
						<p style="font-size:18px;margin-top:58px;">
							<b><a href="#" style="color:black;">印章管理<span id="sealCountSpan" style="color:green;margin:0 15px 0 15px"></span>个</a></b>
						</p>
					</div>					
					<div id="loginUsersChart" class="col-md-3 col-sm-4 col-xs-6 text-center" style="height:400px;border-left:10px solid #F5F5F5;border-right:10px solid #F5F5F5;">						
					</div>	
									
					<div id="moulageChart" class="col-md-3 col-sm-4 col-xs-6 text-center" style="height:400px;border-left:20px solid #F5F5F5;">
					</div>	
					
				</div>
				<div id="tab-content" style="margin-top:50px">
					<ul id="tab_1" class="nav nav-pills" >							    
					    <li id="dayUser" node-data="tab_day_user" class="active"  onclick="getCountData('day','userCollectInfo')"><a data-toggle="tab" href="#tab_task">24小时内登录用户</a></li>
					    <li id="monthUser" node-data="tab_month_user"  onclick="getCountData('month','userCollectInfo')"><a data-toggle="tab" href="#tab_workhour">1个月内登录用户</a></li>
					    <li id="yearUser" node-data="tab_year_user"  onclick="getCountData('year','userCollectInfo')"><a data-toggle="tab" href="#tab_checkin">1年内登录用户</a></li>					    
					</ul>
					<div style="clear:both"></div>	
					<div id="userCollectInfo" class="tab-pane"  style="height:100%">
					</div>																																	
				</div>
				<div id="tab-content" style="margin:50px 0 50px 0">
					<ul id="tab_1" class="nav nav-pills" >							    
					    <li id="userList" node-data="tab_user_list" class="active"  ><a data-toggle="tab" href="#tab_task">当前登录用户</a></li>
					</ul>
					<div style="clear:both"></div>
				<table id="userTable">
                    <thead>
                    <tr>
                        <th>用户名</th><th>用户姓名</th><th>所属部门</th><th>手机号</th><th>最后操作时间</th><th>操作</th>
                    </tr>
                    </thead>
                    <tbody>     
                    </tbody>
                </table>																																		
				</div>
				<div id="tab-content">
					<ul id="tab_3" class="nav nav-pills" >							    
					    <li id="daySeal" node-data="tab_day_seal" class="active"  onclick="getCountData('day','sealCollectInfo')"><a data-toggle="tab" href="#tab_task">24小时内印章使用</a></li>
					    <li id="monthSeal" node-data="tab_month_seal"  onclick="getCountData('month','sealCollectInfo')"><a data-toggle="tab" href="#tab_workhour">1个月内印章使用</a></li>
					    <li id="yearSeal" node-data="tab_year_seal"  onclick="getCountData('year','sealCollectInfo')"><a data-toggle="tab" href="#tab_checkin">1年内印章使用</a></li>					    
					</ul>
					<div style="clear:both"></div>	
					<div id="sealCollectInfo" class="tab-pane"  style="height:100%">
					</div>																																	
				</div>
				
		</div>
	</body>
	<script type="text/javascript">
	
   $(function(){
		//图表的全局配置
	    Highcharts.setOptions({
	      lang: {
	        contextButtonTitle: "图表导出菜单",
	        decimalPoint: ".",
	        downloadJPEG: "下载JPEG图片",
	        downloadPDF: "下载PDF文件",
	        downloadPNG: "下载PNG文件",
	        downloadSVG: "下载SVG文件",
	        drillUpText: "返回 {series.name}",
	        loading: "加载中",
	        months: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
	        noData: "没有数据",
	        numericSymbols: ["千", "兆", "G", "T", "P", "E"],
	        printChart: "打印图表",
	        resetZoom: "恢复缩放",
	        resetZoomTitle: "恢复图表",
	        shortMonths: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
	        thousandsSep: ",",
	        weekdays: ["星期一", "星期二", "星期三", "星期三", "星期四", "星期五", "星期六", "星期天"]
	      },
	      colors: ['#3498db', '#2ecc71', '#f1c40f', '#f39c12', '#9b59b6', '#c0392b', '#1abc9c', '#d35400', '#bdc3c7', '#34495e', '#7f8c8d', '#16a085', '#27ae60', '#e74c3c', '#8e44ad', '#2980b9', '#95a5a6', '#2c3e50'],
	      legend : {
	        itemStyle :{
	          'fontSize' : '12px',
	          'fontFamily': '微软雅黑'
	        }
	      },
	      chart: {
	        style: {
	          'fontSize' : '12px',
	          'fontFamily': '微软雅黑'
	        }
	      },
	      tooltip: {
	        style: {
	          'fontSize' : '12px',
	          'fontFamily': '微软雅黑'
	        }
	      },
	      labels:{
	        style: {
	          'fontSize' : '12px',
	          'fontFamily': '微软雅黑'
	        }
	      }
	    });		
  	    
	    getCountData('day','userCollectInfo');
	    getCountData('day','sealCollectInfo'); 
	    getUserinfo();
   }) 
   
   function getUserinfo(){
		$.ajax({
			type : "GET",
			data :{},
			url : "http://localhost:8080/ESS/api/userInfo",
			dataType : "json",
			async:false,
			success : function(data) {
				if(data.lastloginTime != null){
					var unixTimestamp = new Date((data.lastloginTime)*1000) ;
					commonTime = unixTimestamp.toLocaleString();					
				}
				var depart =data.department.allName + (data.lowerLevel? '(' : '(不') + '包含下级)';
				document.getElementById("usernameP").innerHTML=data.name?data.name:data.username;
				document.getElementById("departmentP").innerHTML='<b>所属单位 :</b> '+depart;
				document.getElementById("roleNameP").innerHTML='<b>身份角色 :</b> '+data.roleName;
				document.getElementById("lastLoginTimeP").innerHTML='<b>上次登陆时间 :</b> '+(data.lastloginTime == null?'未登录':commonTime);
				document.getElementById("emailP").innerHTML='<b>邮箱 :</b> '+(data.email == null?'':data.email);
				document.getElementById("mobileP").innerHTML='<b>手机号码 :</b> '+(data.mobile == null?'':data.mobile);
				document.getElementById("workTelephoneP").innerHTML='<b>办公电话 :</b> '+(data.workTelephone == null?'':data.workTelephone);
				//$("#userTable tbody").append('<tr style="background:white;"><td>'+data.username+'</td><td>' +data.name+'</td><td>'+depart+'</td><td>'+(data.mobile == null?'无':data.mobile)+'</td><td>'+commonTime+'</td><td>'+'<a onclick="kick(\''+data.id+'\')">踢出</a>'+'</td><tr>');
				$("#userTable tbody").append('<tr style="background:white;"><td>'+data.username+'</td><td>' +data.name+'</td><td>'+depart+'</td><td>'+(data.mobile == null?'无':data.mobile)+'</td><td>'+commonTime+'</td><td><tr>');
			}
		});
   }
   
   Date.prototype.toLocaleString = function() {
       return this.getFullYear() + "-" + (this.getMonth() + 1) + "-" + this.getDate() + " " + this.getHours() + ":" + this.getMinutes() + ":" + this.getSeconds();
   };
   
/*    function kick(userId){
		layer.confirm('确实要踢出此用户吗?', {
			  btn: ['确定','取消'] //按钮
		}, function(){//确定事件
			$.ajax({
				type : "GET",
				url : "http://localhost:8080/ESS/api/logoutUsers?userId="+userId,
				dataType : "json",
				success : function(retdata) {
					getCountData('day',"userCollectInfo");
				}
			});
		});
   } */
   
    function getCountData(dateType,countType){
		$.ajax({
			type : "GET",
			data :{type : dateType},
			url : "http://localhost:8080/ESS/api/"+countType,
			dataType : "json",
			async:false,
			success : function(data) {
 	          if(countType == 'userCollectInfo'){
 	        	getConfig(0,"用户数");
 	        	getConfig(1,'当前登录用户');  
	            var loginUsersCount = data.loginUsersCount;
	            var notLoginUsersCount  = data.userCount - loginUsersCount;
	            var userSeriesData = [];
	            userSeriesData.push(["登录用户",loginUsersCount === null? 0:loginUsersCount]);
	            userSeriesData.push(["未登录用户",notLoginUsersCount === null? 0:notLoginUsersCount]);
	            $('#loginUsersChart').highcharts().series[0].setData([]);
	            $('#loginUsersChart').highcharts().series[0].setData(userSeriesData);
	            var users = data.loginUsersName;	            
	          }else if(countType == 'sealCollectInfo'){
	        	  getConfig(0,"印章数");
	        	  getConfig(1,'印模'); 
	              var moulageInfo = data.moulageInfo;
	              var moulageSeriesData = [];
	              moulageSeriesData.push(["未审批", moulageInfo[0] === null? 0:moulageInfo[0]]);
	              moulageSeriesData.push(["已通过", moulageInfo[1] === null? 0:moulageInfo[1]]);
	              moulageSeriesData.push(["未通过", moulageInfo[2] === null? 0:moulageInfo[2]]);
	              $('#moulageChart').highcharts().series[0].setData(moulageSeriesData);
	              var sealCount = data.sealCount;
	              var moulageCount = moulageInfo[0]+moulageInfo[1]+moulageInfo[2];	              
	              document.getElementById("moulageCountSpan").innerHTML = sealCount;
	              document.getElementById("sealCountSpan").innerHTML = moulageCount;
	          }
			  getCollectInfo(dateType,countType,data);
			}
		});
      }
    
    function getConfig(type,p){
        switch (type) {
        case 0:
        	var lineChartObj = '';
        	if(p == '用户数'){
        		lineChartObj = '#userCollectInfo';
        	}else if(p == '印章数'){
        		lineChartObj = '#sealCollectInfo';
        	}
	  	    $(lineChartObj).highcharts({
	             chart: {
	            	 type: 'line'
	             },
	             tooltip: {
	                  formatter: function() {
	                    return '<b>'+ this.series.name + '</b>' + ': '+ this.y + '<br/>';
	                  }
	             },
	            title: {  text: '<h4>'+ p +'统计图</h4>',
	                align: 'left',
	                floating: false,
	                x: 10,
	                y: 10,
	                useHTML: true
	              },
	              xAxis: {
	                categories: []
	              },
	              yAxis: {
	                tickInterval:1,
	                title: { text: p }
	              },
	              plotOptions: {
	                  line: {
	                  }
	              },
	              series: [{ name: p, data: [] }],
		          credits: {//图表版权配置
			            enabled: false // 是否显示版权信息
			      }
	   	 });          	
        case 1:
        	var pieObj = '';
        	if(p == '当前登录用户'){
        		pieObj = '#loginUsersChart';
        	}else if(p == '印模'){
        		pieObj = '#moulageChart';
        	}
	  	    $(pieObj).highcharts({
	            chart: {//通用参数
	              plotBackgroundColor: null,
	              plotBorderWidth: null,
	              plotShadow: false,
	              type: 'pie',//配置图表类型为饼状图
	            },
	            tooltip: {
	              pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
	            },
	          series: [{
	            name: '占',
	            data: []//图表数据
	          }],
	          plotOptions: {
	            pie: {
	              allowPointSelect: true,
	              cursor: 'pointer',
	              dataLabels: {
	                enabled: true
	              }
	              //showInLegend: true
	            }
	          },
	          title: {//标题
	            text: '<h4>'+  p +'统计</h4>',
	            align: 'left',
	            floating: false,
	            x: 10,
	            y: 10,
	            useHTML: true
	          },
	          loading: false,//加载时文本的显示
	          credits: {//图表版权配置
	            enabled: false // 是否显示版权信息
	          }
	   	 });       	
       }
     }
    
      function getCollectInfo(dateType,countType,data){
    	var lineChartObj = '';
    	if(countType == 'userCollectInfo'){
    		lineChartObj = '#userCollectInfo';
    	}else if(countType == 'sealCollectInfo'){
    		lineChartObj = '#sealCollectInfo';
    	}
    	
        var thisHour = new Date().getHours();
        var today = new Date().getDate();
        var thisMonth = new Date().getMonth() + 1;
        var lastMonth = new Date().getMonth() == 0? 12 : new Date().getMonth();
        var historyInfo = data.historyInfo;
        if(dateType == 'day'){
        	var dayXSeries = [];
        	var dayYSeries = [];
          for(var h = 1;h<=24;h++){
        	 dayXSeries.push([(h+thisHour)%24+'时']);
        	 dayYSeries.push(historyInfo[(h+thisHour)%24] === null? 0 : historyInfo[(h+thisHour)%24]);
          }
     	 $(lineChartObj).highcharts().xAxis[0].setCategories(dayXSeries);
     	 $(lineChartObj).highcharts().series[0].setData(dayYSeries);
        }else if(dateType == 'month'){
          var monthXSeries = [];
          var monthYSeries = [];
          var allDays = 0;
          var d, ds = [], mds=[];
          lastMonth = (lastMonth < 10 ? "0" : "") + lastMonth;
          thisMonth = (thisMonth < 10 ? "0" : "") + thisMonth;
          for(d = 31;d >= 28;d--){
            if(historyInfo[(lastMonth+ "" + d)] !== undefined){
              allDays = d;
              break;
            }
          }
          for(d = 0;d < 30;d++){
            var day = today - d;
            if(day > 0){
              ds.push(thisMonth + (day < 10 ? "0" : "") + day);
              mds.push(parseInt(thisMonth) + "月" + day + "日");
            }else{
              day += allDays;
              ds.push(lastMonth + (day < 10 ? "0" : "") + day);
              mds.push(parseInt(lastMonth) + "月" + day + "日");
            }
          }
          for(d = 29;d >= 0;d--){
        	monthXSeries.push(mds[d]);
        	monthYSeries.push(historyInfo[ds[d]] === null? 0 : historyInfo[ds[d]]);
          }
          $(lineChartObj).highcharts().xAxis[0].setCategories(monthXSeries);
      	  $(lineChartObj).highcharts().series[0].setData(monthYSeries);
        }else{
          var yearXSeries = [];
          var yearYSeries = [];
          for(var m = 0;m<12;m++){
        	yearXSeries.push((m+thisMonth)%12+1+'月');
            yearYSeries.push(historyInfo[(m+thisMonth)%12+1] === null? 0 : historyInfo[(m+thisMonth)%12+1]);
          }
          $(lineChartObj).highcharts().xAxis[0].setCategories(yearXSeries);
      	  $(lineChartObj).highcharts().series[0].setData(yearYSeries);          
        }
      }
    
    
	</script>
</html>
