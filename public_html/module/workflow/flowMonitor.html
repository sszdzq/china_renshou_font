<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>流程监控</title>

  	<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.min.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/index-ess.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/font-awesome.min.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/document.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/dj-bootstrap.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/dj-tab.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/index-ess.css"  type="text/css" />
	    <!-- jqgrid样式 -->
	    <link href="../../shared/jqgrid/css/ui.jqgrid.css" type="text/css"  rel="stylesheet" />
	    <link href="../../shared/jqgrid/css/css/flick/jquery-ui-1.8.16.custom.css" type="text/css"  rel="stylesheet" />
	    
	    
	    	<!--javascript引用部分 -->
	   <script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script>
	   <script src="../../shared/js/jquery.extend.js" type="text/javascript"></script>
	   <script src="../../shared/js/myLayer.js" type="text/javascript"></script>
	   <script src="../../shared/ztree/js/jquery.ztree.core.min.js" type="text/javascript"></script>
	   
		<!-- jqgridjs -->
	    <script src="../../shared/jqgrid/js/jquery.jqGrid.min.js" type="text/javascript"></script>
		<script src="../../shared/jqgrid/js/jquery.jqGrid.extend.js" type="text/javascript"></script>
		<script type="text/javascript" src="../../shared/jqgrid/js/i18n/grid.locale-cn.js"></script>
		
		<script src="../../shared/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	    <script src="../../shared/layer/layer.js" type="text/javascript"></script>	    
	    <!-- my97 DatePicker  -->
	    <script src="../../shared/my97/WdatePicker.js" type="text/javascript"></script>	
	    <script src="../../shared/plugins/utils.js" type="text/javascript"></script>
	     <script src="../../shared/ocx/makeseal.js"  type="text/javascript" ></script>
<style type="text/css">
a{
	color: blue !important;
	font-weight: normal;
	margin-right: 5px;
}

</style>



</head>
<body>
<div class="pagecontent" id="divcontent2">
	<div class="centerLayer">
		<!-- 工具条 -->
		<div id="toolbars" class="toolbars">
			<form id="search_form" class="searchform" onsubmit="return false;">
				<input type="text" name="djid"  id="djid" placeholder="单据ID" />
				<input type="text" name="djmc"  id="djmc" placeholder="单据名称" />
				<button type="button" onclick="search()" class="btn btn-primary"><i class="fa fa-th"></i> 查询</button>
			</form>
		</div>
		<!-- 页面主内容 -->
		<div class="gridcontent">
			<table id="invoice_grid"></table>
			<div id="lcjkmap"></div>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">

    //选中当前树的ID,用于存放单位ID
    var zTreeID;
    var urlPath=getUrlPath();
    //初始化layer
    $("#divcontent2").mylayer("init");

    //加载数据
    function loadGrid() {
        $("#invoice_grid").jqGrid({
            url : urlPath+'/LcjkController/lcjkQueryPage',
            datatype : "json",//页面加载的时候不显示数据
            colNames : [ '操作','实例ID', '工作流ID', '单据类型ID','单据类型名称','单据ID','单据名称','制单单位名称','制单人ID','制单人','制单时间','流程状态'],
            colModel : [
                {name : 'cz',index : 'cz',width : 250,align : "center",formatter:function(cellvalue, options, rowObject){
                    return "<a href='javascript:doLclook(\""+rowObject.gzlid+"\",\""+rowObject.slid+"\")'>查看流程</a><a href='javascript:stopLcxx(\""+rowObject.slid+"\")'>终止流程</a><a href='javascript:updateLcxx(\""+rowObject.slid+"\",\""+rowObject.gzlid+"\")'>修改人员</a><a href='javascript:delLcxx(\""+rowObject.slid+"\")'>删除流程</a>";
                }},
                {name : 'slid',index : 'slid',width : 100,hidden : true},
                {name : 'gzlid',index : 'gzlid',width : 200,hidden : true},
                {name : 'djlxid',index : 'djlxid',width : 100,hidden : true},
                {name : 'djlxmc',index : 'djlxmc',width : 100,align : "center"},
                {name : 'djid',index : 'djid',width : 200,align : "center"},
                {name : 'djmc',index : 'djmc',width : 150},
                {name : 'dwmc',index : 'dwmc',width : 200,align : "center"},
                {name : 'zdyhid',index : 'zdyhid',width : 100,align : "center",hidden : true},
                {name : 'zdyhxm',index : 'zdyhxm',width : 130,align : "center"},
                {name : 'firsttime',index : 'firsttime',width : 150,align : "center",formatter:dateFormatter},
                {name : 'lczt',index : 'lczt',width : 100,align : "center"}
            ],
            pager : '#lcjkmap',
            multiselect : false, //多行
            rownumbers : true //显示行号
        });
    }

    //加载jqGrid
    $(document).ready(function() {
        loadGrid();

        $(window).resize(function() {
            $("#invoice_grid").jqGrid("autoSize");
        }).trigger('resize');
    });

    //绑定回车事件
    document.onkeydown = function(e) {
        var ev = document.all ? window.event : e;
        if (ev.keyCode == 13) {
            search();
        }
    };

    //查询功能
    function search() {
        var formData = $("#search_form").getData();
        $("#invoice_grid").jqGrid('setGridParam', {
            postData : {
                djid : formData.djid,
                djmc : formData.djmc
            }
        }).trigger("reloadGrid");
    }

    //终止流程
    function stopLcxx(slid){
        layer.alert('确定终止此流程？', {
            time: 0, //不自动关闭,
            btn: ['确定', '关闭'],
            yes: function(index){
                $.ajax({
                    type : "POST",
                    url : urlPath+"/LcjkController/stopLc",
                    data : {slid:slid},
                    dataType : "json",
                    //traditional: true,  //ajax传递数组的时候traditional必须为true
                    success : function(retdata) {
                        if (retdata.code == 200) {
                            msg('操作成功！');
                            //刷新jqGrid
                            $("#invoice_grid").jqGrid('setGridParam',{
                                postData:{}}
                            ).trigger("reloadGrid");
                        } else {
                            alert(retdata.message);
                        }
                    }
                });
            }
        });
    }

    //删除流程
    function delLcxx(slid){
        //删除提示
        layer.alert('确定要删除此数据？', {
            time: 0, //不自动关闭,
            btn: ['确定', '关闭'],
            yes: function(index){
                $.ajax({
                    type : "POST",
                    url : urlPath+"/LcjkController/delLc",
                    data : {slid:slid},
                    dataType : "json",
                    traditional: true,//ajax传递数组的时候traditional必须为true
                    success : function(retdata) {
                        if (retdata.code == 200) {
                            msg('操作成功！');
                            //刷新jqGrid
                            $("#invoice_grid").jqGrid('setGridParam',{
                                    postData:{}
                                }
                            ).trigger("reloadGrid");
                        } else {
                            alert(retdata.message);
                        }
                    }
                });
            }
        });
    }

    //修改流程人员信息
    function updateLcxx(slid,gzlid){
        openEdit_modify(slid,gzlid);
    }

    //修改人员编辑框
    function openEdit_modify(slid,gzlid){
        layer.open({
            title:'配置流程',
            type: 2,
            content: '../workflow/workflow_common_selUser.html?gzlid='+gzlid+'&slid='+slid,
            area: ['760px', '600px'],
            btn: ['确定','关闭'],
            maxmin: true,
            yes: function(index){
                //获取表达式数据
                var res = window["layui-layer-iframe" + index].saveData();
                if(res==false){
                    msg("保存配置信息出错");
                }else{
                    msg("保存配置信息成功");
                    layer.close(index);
                }
            }
        });
    }

    //查看流程
    function doLclook(tgzlid,tslid){
        layer.open({
            title:'工作流程查看',
            type: 2,
            content: "../workflow/workflow_show.html?gzlid="+tgzlid+"&slid="+tslid,
            btn: ['确定','关闭'],
            area: ['100%', '100%'],
            yes: function(index){
                layer.close(index);
            }
        });
    }

	/*
	 * 2018/11/27 弃用
	 */
    //启动、终止、修改、删除
    function doAction(type){
        if(type==1){
            //重启流程
            var id = $("#invoice_grid").jqGrid('getGridParam','selrow');
            if(id!=null){
                var row = $("#invoice_grid").jqGrid('getRowData', id);
                openEdit_restart(row.slid);
            }else{
                alert('请选择要重启的流程！');
            }
        }else if(type==2){
            //终止流程
            var id = $("#invoice_grid").jqGrid('getGridParam','selrow');
            if(id!=null){
                var row = $("#invoice_grid").jqGrid('getRowData', id);
                layer.alert('确定终止此流程？', {
                    time: 0, //不自动关闭,
                    btn: ['确定', '关闭'],
                    yes: function(index){
                        $.ajax({
                            type : "POST",
                            url : urlPath+"/LcjkController/stopLc",
                            data : {slid:row.slid},
                            dataType : "json",
                            //traditional: true,  //ajax传递数组的时候traditional必须为true
                            success : function(retdata) {
                                if (retdata.flag == true) {
                                    msg('操作成功！');
                                    //刷新jqGrid
                                    $("#invoice_grid").jqGrid('setGridParam',{
                                            postData:{}
                                        }
                                    ).trigger("reloadGrid");
                                } else {
                                    alert(retdata.msg);
                                }
                            }
                        });
                    }
                });
            }else{
                alert('请选择要终止的流程！');
            }
        }else if(type==3){
            //修改人员信息
            var id = $("#invoice_grid").jqGrid('getGridParam','selrow');
            if(id!=null){
                var row = $("#invoice_grid").jqGrid('getRowData', id);
                openEdit_modify(row.slid,row.gzlid);
            }else{
                alert('请选择要修改的数据！');
            }
        }else if(type==4){
            //获取选定行行id
            var rowid = $("#invoice_grid").jqGrid('getGridParam','selrow');
            var row = $("#invoice_grid").jqGrid('getRowData', rowid);
            if(rowid == null){
                alert('请选择要删除的数据！');
            }else{
                //删除提示
                layer.alert('确定要删除此数据？', {
                    time: 0, //不自动关闭,
                    btn: ['确定', '关闭'],
                    yes: function(index){
                        $.ajax({
                            type : "POST",
                            url : urlPath+"/LcjkController/delLc",
                            data : {slid:row.slid},
                            dataType : "json",
                            traditional: true,//ajax传递数组的时候traditional必须为true
                            success : function(retdata) {
                                if (retdata.flag == true) {
                                    msg('操作成功！');
                                    //刷新jqGrid
                                    $("#invoice_grid").jqGrid('setGridParam',{
                                            postData:{}
                                        }
                                    ).trigger("reloadGrid");
                                } else {
                                    alert(retdata.msg);
                                }
                            }
                        });
                    }
                });
            }
        }
    }

    //重启流程编辑框
    function openEdit_restart(slid){
        var index = layer.open({
            title:'重启流程',
            type: 2,
            content: '${path}/gzlc/lcjk/lcjk_restart.jsp?slid='+slid,
            area: ['410px', '220px'],
            btn: ['保存','关闭'], //底部按钮区域
            maxmin: true,
            yes: function(index,layero){  //第一个按钮的事件
                //调用子页面的方法
                var res = window[layero.find('iframe')[0]['name']].getData();
                if(res!=null){
                    $.ajax({
                        type : "POST",
                        url : urlPath+"/LcjkController/restartLc",
                        data : res,
                        dataType : "json",
                        success : function(retdata) {
                            if(retdata.flag){
                                //刷新
                                $("#invoice_grid").jqGrid('setGridParam',{
                                    postData:{}
                                }).trigger("reloadGrid");
                                //关闭页面
                                layer.close(index);
                                msg(retdata.msg);
                            }else{
                                alert(retdata.msg);
                            }
                        }
                    });
                }
            }
        });
    }
	function dateFormatter(cellvalue, options, rowObject){
         var date=new Date(cellvalue);
        return dateFtt("yyyy-MM-dd hh:mm:ss",date);
	}
    function dateFtt(fmt,date)
    { //author: meizz
        var o = {
            "M+" : date.getMonth()+1,                 //月份
            "d+" : date.getDate(),                    //日
            "h+" : date.getHours(),                   //小时
            "m+" : date.getMinutes(),                 //分
            "s+" : date.getSeconds(),                 //秒
            "q+" : Math.floor((date.getMonth()+3)/3), //季度
            "S"  : date.getMilliseconds()             //毫秒
        };
        if(/(y+)/.test(fmt))
            fmt=fmt.replace(RegExp.$1, (date.getFullYear()+"").substr(4 - RegExp.$1.length));
        for(var k in o)
            if(new RegExp("("+ k +")").test(fmt))
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
        return fmt;
    }

</script>
</html>