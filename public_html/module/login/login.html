<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"><META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="0">
<link rel="stylesheet" href="../../shared/css/index-ess.css"  type="text/css" />
<link rel="stylesheet" href="../../shared/css/font-awesome.min.css"  type="text/css" />
<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.css"  type="text/css" />
<script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script>
<script src="../../shared/js/json2.js" type="text/javascript"></script>
<script src="../../shared/crypto-js/crypto-js.js" type="text/javascript"></script>
<script src="../../shared/js/jquery.extend.js" type="text/javascript"></script>
<script src="../../shared/js/myLayer.js" type="text/javascript"></script>
<script src="../../shared/layer/layer.js" type="text/javascript"></script>
<script src="../../shared/plugins/utils.js" type="text/javascript"></script>
<style type="text/css">
.login{
    position: fixed;
    height: 100%;
    width: 100%;
    overflow-y: auto;
    background-color: #2A363F;
}
.login-main{
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
    position: absolute;
    top: 50%;
    margin-top: -150px;
    min-width: 320px;
    margin-left: 16.66667%;
    width: 66.66667%;
    float: left;
    padding-left: 0.83333%;
    padding-right: 0.83333%;
    }
.login-main .login-title{
	padding-top: 20px;
}
.login-main .text-center{
	width: 50%;
    float: left;
    padding-left: 0.83333%;
    padding-right: 0.83333%;
}
.text-center{
	text-align: center;
}
.login-main .last-child{
	border-left: 1px solid #202930;
}
.login-main .last-child{
	width: 38.66667%;
    float: left;
    padding-left: 0.83333%;
    padding-right: 0.83333%;
}
.login-form{
	padding: 15px 20px;
    position: relative;
}
.login-main .login-title .img-logo{
	width: 105px;
    height: 105px;
}
.login-main .login-title h2{
	    font-size: 40px;
}
.login-main h2{
	text-align: center;
    color: #ffffff;
    line-height: 2.2em;
    font-weight: normal;
}
.login-form .control-group{
	margin-bottom: 8px;
    position: relative;
}
.login-form .login-field{
	font-size: 17px;
    padding: 12px 42px 12px 15px;
    width: 85%;
    margin-bottom: 10px !important;
}
.login-form .login-field-icon{
	color: #818a91;
    font-size: 20px;
    position: absolute;
    right: 15px;
    top: 14px;
}
.btn-block{
	display: block !important;
    width: 100% !important;
}
.btn {
    color: #333333;
    text-align: center;
    text-shadow: 0 1px 1px rgba(255, 255, 255, 0.75);
    vertical-align: middle;
    cursor: pointer;
    background-color: #f5f5f5;
    background-repeat: repeat-x;
    border: 1px solid #cccccc;
    border-color: #e6e6e6 #e6e6e6 #bfbfbf;
    border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    border-bottom-color: #b3b3b3;
    -webkit-border-radius: 4px;
    -moz-border-radius: 4px;
    border-radius: 4px;
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffffff', endColorstr='#ffe6e6e6', GradientType=0);
    filter: progid:DXImageTransform.Microsoft.gradient(enabled=false);
    -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
}
.btn:hover, .btn:focus, .btn.focus {
    color: #333;
    text-decoration: none;
    background-position: 0 -60px;
}
.btn-primary {
    color: #fff !important;
    background-color: #337ab7 !important;
    border-color: #2e6da4 !important;
}
.btn-primary:hover {
    color: #fff;
    background-color: #286090;
    border-color: #204d74;
}
.btn-primary:hover {
    color: #fff;
    background-color: #286090;
    border-color: #204d74;
}
.btn-lg{
	padding: 10px 16px;
    font-size: 18px;
    line-height: 1.3333333;
    border-radius: 6px;
}
</style>
</head>
<body>
<div class="login ng-scope">
  <div class="login-main">
    <div class="text-center login-title">
      <img class="img-logo" src="../../shared/images/seal.png">
      <h2>电子印章管理系统</h2>
    </div>
    <div class="last-child">
      <div class="login-form">
        <form name="loginForm">
          <div class="control-group">
            <input type="text" name="loginId" id="loginId" class="login-field" accesskey="n" placeholder="请输入用户名" title="请输入用户名" required="required">
            <label class="login-field-icon fa fa-user"></label>
          </div>
          <div class="control-group">
            <input type="password" name="password" id="password" class="login-field" accesskey="p" placeholder="请输入密码" title="请输入密码" required="required" onKeyUp="checkNameAndPassword()" onblur="checkNameAndPassword()">
            <label class="login-field-icon fa fa-lock"></label>
          </div>
          <div class="control-group">
            <button type="button" accesskey="s"  id="login" class="btn btn-primary btn-lg btn-block" disabled="disabled" onclick="essLogin()">登录</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
</body>
<script type="text/javascript">
var apiUrl = getUrlPath();

$(document).ready(function() {
	//setTimeout(function(){getProofCode()}, 1000);
});

function checkNameAndPassword(){
	var name = $("#loginId").val();
	var password = $("#password").val();
	 
	if(name != "" && password != ""){
		$("#login").removeAttr("disabled");
	}
}

function essLogin(){
		var name = $("#loginId").val();
		var password = $("#password").val();
		password = handlePassword(password);
		var o = {"loginId":name,"password":password};
		$.ajax({
			type : "POST",
			url : apiUrl + "/login?noCache="+new Date().getTime(),
			data : JSON.stringify(o),
			dataType : "json",
			contentType:"application/json",
			success : function(data) {
				//layer.msg('登录成功', {icon: 1});
				if (data.error === 4106) {
					layer.msg('密码已过期，前往修改页！', {icon: 5});
						setTimeout(window.location.replace('../../module/login/reset.html?id='+data.id+'&name='+data.name+'&noCache='+new Date().getTime()),800);
					} else {
						window.location.replace('../../module/dashboard/main_page.html?noCache='+new Date().getTime());
					}
			},
			error : function(xmlhttp,textStatus,errorThrown){
				var o = JSON.parse(xmlhttp.responseText);
				layer.msg(o.message, {icon: 5});
			}
		});
}


function handlePassword(pwd){
	var convertPassword = CryptoJS.SHA256(pwd).toString(CryptoJS.enc.HEX);
	var keyHex = CryptoJS.enc.Utf8.parse(getProofCode());
    var encrypted = CryptoJS.DES.encrypt(convertPassword,keyHex,{
        mode : CryptoJS.mode.ECB,
        padding : CryptoJS.pad.Pkcs7
    });
    ////console.log(encrypted.toString());
	return encrypted.toString();
}

var limitCount=0;
function getProofCode(){
	var proofCode = null;
	limitCount++;
	//console.log(limitCount);
 	$.ajax({
		type : "GET",
		url : apiUrl +'/getProofCode?noCache='+new Date().getTime(),
		contentType:"text/html",
		async:false,
		success : function(retdata) {
			proofCode = retdata;
			////console.log(proofCode);
		},
		error : function(xmlhttp,textStatus,errorThrown){
			if(limitCount < 3){
				getProofCode();				
			}else{
				var o = JSON.parse(xmlhttp.responseText);
				top.layer.msg("登陆失败!");
			}
		}
	}); 
 	return proofCode;
}

//回车事件
$(function(){
	document.onkeydown = function(e){ 
	    var ev = document.all ? window.event : e;
	    if (ev.keyCode==13) {
	    	essLogin();
	    }
	};
});
</script> 
</html>