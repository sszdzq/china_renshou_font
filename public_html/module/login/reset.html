<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=8" />
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"><META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="0">
<link rel="stylesheet" href="../../shared/css/index-ess.css"  type="text/css" />
<link rel="stylesheet" href="../../shared/css/font-awesome.min.css"  type="text/css" />
<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.css"  type="text/css" />
<script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script>
<script src="../../shared/crypto-js/crypto-js.js" type="text/javascript"></script>
<script src="../../shared/js/jquery.extend.js" type="text/javascript"></script>
<script src="../../shared/js/myLayer.js" type="text/javascript"></script>
<script src="../../shared/layer/layer.js" type="text/javascript"></script>
<script src="../../shared/plugins/utils.js" type="text/javascript"></script>
<style type="text/css">
.login{
    position: fixed;
    height: 100%;
    width: 100%;
    overflow-y: auto;
    background-color: #2A363F;
}
.login-main{
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
    position: absolute;
    top: 50%;
    margin-top: -150px;
    min-width: 320px;
    margin-left: 16.66667%;
    width: 66.66667%;
    float: left;
    padding-left: 0.83333%;
    padding-right: 0.83333%;
    }
.login-main .login-title{
	padding-top: 20px;
}
.login-main .text-center{
	width: 50%;
    float: left;
    padding-left: 0.83333%;
    padding-right: 0.83333%;
}
.text-center{
	text-align: center;
}
.login-main .last-child{
	border-left: 1px solid #202930;
}
.login-main .last-child{
	width: 38.66667%;
    float: left;
    padding-left: 0.83333%;
    padding-right: 0.83333%;
}
.login-form{
	padding: 15px 20px;
    position: relative;
}
.login-main .login-title .img-logo{
	width: 105px;
    height: 105px;
}
.login-main .login-title h2{
	    font-size: 40px;
}
.login-main h2{
	text-align: center;
    color: #ffffff;
    line-height: 2.2em;
    font-weight: normal;
}
.login-form .control-group{
	margin-bottom: 8px;
    position: relative;
}
.login-form .login-field{
	font-size: 17px;
    padding: 12px 42px 12px 15px;
    width: 85%;
    margin-bottom: 10px !important;
}
.login-form .login-field-icon{
	color: #818a91;
    font-size: 20px;
    position: absolute;
    right: 15px;
    top: 14px;
}
.btn-block{
	display: block !important;
    width: 100% !important;
}
.btn {
    color: #333333;
    text-align: center;
    text-shadow: 0 1px 1px rgba(255, 255, 255, 0.75);
    vertical-align: middle;
    cursor: pointer;
    background-color: #f5f5f5;
    background-repeat: repeat-x;
    margin-left:20px;
    border: 1px solid #cccccc;
    border-color: #e6e6e6 #e6e6e6 #bfbfbf;
    border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    border-bottom-color: #b3b3b3;
    -webkit-border-radius: 4px;
    -moz-border-radius: 4px;
    border-radius: 4px;
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffffff', endColorstr='#ffe6e6e6', GradientType=0);
    filter: progid:DXImageTransform.Microsoft.gradient(enabled=false);
    -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
}
.btn:hover, .btn:focus, .btn.focus {
    color: #333;
    text-decoration: none;
    background-position: 0 -60px;
}
.btn-primary {
    color: #fff !important;
    background-color: #337ab7 !important;
    border-color: #2e6da4 !important;
}
.btn-primary:hover {
    color: #fff;
    background-color: #286090;
    border-color: #204d74;
}
.btn-primary:hover {
    color: #fff;
    background-color: #286090;
    border-color: #204d74;
}
.btn-lg{
	padding: 10px 16px;
    font-size: 18px;
    line-height: 1.3333333;
    border-radius: 6px;
}
.msg{
    height:25px
}
</style>
</head>
<body>
<div class="login ng-scope">
  <div class="login-main">
    <div class="text-center login-title">
      <img class="img-logo" src="../../shared/images/seal.png">
      <h2>用户密码重置：<span id="userName"></span></h2>
    </div>
    <div class="last-child">
      <div class="login-form">
       <form name="upForm" role="form" class="form-horizontal" style="margin:0px" novalidate>
			        <div class="has-feedback form-group">
			             <div class="col-xs-6">
			                <input type="password" id="oldPassword" name="oldPassword" onchange="checkPwForm('oldPassword');" style="height:35px" class="formcontrol"  placeholder="请输入原密码"
			                       maxlength="20"  >
			                       <input type="hidden" id="proofCode" name="proofCode">
			            </div>
			            <div class="msg text-danger" id="oldPasswordMsg"></div>
			        </div>
			        <div class="has-feedback form-group">
			            <div class="col-xs-6">
			                <input type="password" id="newPassword" name="newPassword" onchange="checkPwForm('newPassword');" style="height:35px" class="formcontrol"  placeholder="请输入新密码"
			                       maxlength="20"  >
			            </div>
			            <div class="msg text-danger" id="newPasswordMsg"></div>
			        </div>
			        <div class="has-feedback form-group">
			            <div class="col-xs-6">
			                <input type="password" name="confirmPassword" id="confirmPassword" onchange="checkPwForm('confirmPassword');" class="formcontrol" style="height:35px"  placeholder="请再次输入密码">
			            </div>
			            <div class="msg text-danger" id="confirmPasswordMsg"></div>
			        </div>
			    </form>
			    <button type="button"
			          class="btn col-padding-3 margin-right-2 btn-primary btn-lg" onclick="updatePw()">重置密码</button>
			  <button type="button" class="btn btn-default col-padding-3 " onclick="goLoginPage()">去登录</button>
      </div>
    </div>
  </div>
</div>
</body>
<script type="text/javascript">
var urlPath = getUrlPath();
var userId;
var proofCode;
$(document).ready(function() {
	setTimeout(function(){getProofCode()}, 1000);
	userId=GetQueryString("id");
	var userName=GetQueryString("name");
	$("#userName").html(userName);
});
function GetQueryString(name){
    var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if(r!=null)return  decodeURI(r[2]); return null;
}
function checkNameAndPassword(){
	var name = $("#loginId").val();
	var password = $("#password").val();
	 
	if(name != "" && password != ""){
		$("#login").removeAttr("disabled");
	}
}
function goLoginPage(){
	window.location.replace('../../module/login/login.html?noCache='+new Date().getTime());
}
function updatePw(){
	if(checkPwForm('oldPassword')||checkPwForm('newPassword')||checkPwForm('confirmPassword')){
		return;
	}
	var newPassword=$("#newPassword").val();
	newPassword = handlePassword(newPassword);
	var oldPassword=$("#oldPassword").val();
	oldPassword = handlePassword(oldPassword);
	var id=userId;
	var confirmPassword=$("#confirmPassword").val();
	var data={"newPassword":newPassword,"oldPassword":oldPassword,"id":id,"confirmPassword":confirmPassword};
	var res=JSON.stringify(data);
	$.ajax({
		type : "POST",
		data :res,
		url : urlPath+"/updatePw",
		dataType : "json",
		contentType:"application/json",
		async:false,
		success : function(data) {
			if(data!=null){
				msg("修改成功！");
				window.location.replace('../../module/dashboard/main_page.html?noCache='+new Date().getTime());
			}
		},
		error:function (e) {
            var res = $.parseJSON(e.responseText);
            alert("修改失败,原因："+res.message);
	    }
	});
}

function checkPwForm(idName){
	 var targetInput=$("#"+idName).val();
	 var msgString="";
	 var errorFlag=false;
	 if(targetInput==""){
		 	msgString="输入不能为空";
		 	errorFlag=true;
	 }else{
		 if(idName=="newPassword"){
			 var oldPassword=$("#oldPassword").val();
			 if(targetInput.length<8||targetInput.length>20||!contentValidate(1,targetInput)){
				 msgString="长度必须在8-20位且包含大小写字母，数字";
				 errorFlag=true;
			 }
		 }
		 if(idName=="confirmPassword"){
			 var oldPassword=$("#newPassword").val();
			 if(targetInput!=oldPassword){
				 msgString="两次输入不一致";
				 errorFlag=true;
			 }
		 }
	 }
	 if(errorFlag){
		 $("#"+idName+"Msg").html('<span class="fa fa-times-circle" style="color:red;font-size:12px">'+msgString+'</span>');
	 	 $("#"+idName).css("border-color","red");
	 }else{
	 	 $("#"+idName+"Msg").html('<span class="fa fa-check text-success-dark" style="color:#f5f5f5" aria-hidden="true"></span>');
	 	 $("#"+idName).css("border-color","#f5f5f5");
	 }
	return errorFlag;
}
function contentValidate(type,content){
	 var regx='';
	 switch(type){
	 case 1:regx ='^(?:(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])).{8,20}$';break;//检查密码是否符合规则;
	 case 2:regx='^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$';break;//校验邮箱
	 case 3:regx='\\d{11}?';break;//校验手机号
	 case 4:regx='\\d{5}\\d*';break//校验工作电话
	 }
	 var reg=new RegExp(regx);
	 var result=reg.test(content);
	 return result;
}

function handlePassword(pwd){
		var proofCode=$("#proofCode").val();
		////console.log(proofCode);
		var convertPassword = CryptoJS.SHA256(pwd).toString(CryptoJS.enc.HEX);
		var keyHex = CryptoJS.enc.Utf8.parse(proofCode);
	    var encrypted = CryptoJS.DES.encrypt(convertPassword,keyHex,{
	        mode : CryptoJS.mode.ECB,
	        padding : CryptoJS.pad.Pkcs7
	    });
	    //console.log(encrypted.toString());
		return encrypted.toString();
	}

function getProofCode(){
	var proofCode = null;
 	$.ajax({
		type : "GET",
		url : urlPath +'/getProofCode?noCache='+new Date().getTime(),
		contentType:"text/html",
		async:false,
		success : function(retdata) {
			$("#proofCode").val(retdata);
			////console.log(proofCode);
		},
		error : function(xmlhttp,textStatus,errorThrown){
			getProofCode();
		}
	}); 
 	return proofCode;
}

//回车事件
$(function(){
	document.onkeydown = function(e){ 
	    var ev = document.all ? window.event : e;
	    if (ev.keyCode==13) {
	    	essLogin();
	    }
	};
	});
</script> 
</html>