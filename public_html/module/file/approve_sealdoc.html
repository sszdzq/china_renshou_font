<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
    <META HTTP-EQUIV="Expires" CONTENT="0">
    <title>文档审核</title>

    <link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.min.css" type="text/css"/>
    <link rel="stylesheet" href="../../shared/css/index-ess.css" type="text/css"/>
    <link rel="stylesheet" href="../../shared/css/font-awesome.min.css" type="text/css"/>
    <link rel="stylesheet" href="../../shared/css/document.css" type="text/css"/>
    <link rel="stylesheet" href="../../shared/css/dj-bootstrap.css" type="text/css"/>
    <link rel="stylesheet" href="../../shared/css/dj-tab.css" type="text/css"/>
    <link rel="stylesheet" href="../../shared/css/main.css" type="text/css"/>
    <link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.css" type="text/css"/>
    <!-- jqgrid样式 -->
    <link href="../../shared/jqgrid/css/ui.jqgrid.css" type="text/css" rel="stylesheet"/>
    <link href="../../shared/jqgrid/css/css/flick/jquery-ui-1.8.16.custom.css" type="text/css" rel="stylesheet"/>


    <!--javascript引用部分 -->
    <script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script>
    <script src="../../shared/js/jquery.extend.js" type="text/javascript"></script>
    <script src="../../shared/js/myLayer.js" type="text/javascript"></script>
    <script src="../../shared/ztree/js/jquery.ztree.core.min.js" type="text/javascript"></script>

    <!-- jqgridjs -->
    <script src="../../shared/jqgrid/js/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="../../shared/jqgrid/js/jquery.jqGrid.extend.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../shared/jqgrid/js/i18n/grid.locale-cn.js"></script>

    <script src="../../shared/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../shared/layer/layer.js" type="text/javascript"></script>

    <!-- my97 DatePicker  -->
    <script src="../../shared/my97/WdatePicker.js" type="text/javascript"></script>
    <script src="../../shared/plugins/utils.js" type="text/javascript"></script>
    <!-- 控件  -->
    <script src="../../shared/ocx/hwpostil.js"  type="text/javascript" ></script>
    <style type="text/css">
        ::-webkit-scrollbar-thumb {
            background: #d9d9d9;
            cursor: pointer;
        }

        select{
            width:auto;
            padding:3px;
        }
        body{
            padding: 0 15px;
        }
        .panel-body{
            padding: 5px;
        }
        form{
            font-size: 15px; width: 100%; border: 0px;
            margin-bottom: 0px !important;
        }
        .panel-heading{
            padding: 4px 15px;
        }

    </style>

</head>
<body>
    <div class="modal right fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display:none">
        <div class="modal-dialog" >
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"  aria-label="Close" onclick='closeModal()'><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">盖章进度提示</h4>
                </div>
                <div class="modal-body">
                    <h4 class="modal-title" id="myModalLabel">正在盖章中，请等待<span class="dotting"></span></h4>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
<div class="margin-top-1" style="height:100%">
    <div class="panel-group" style="height:100%;overflow:auto;">
        <div class="panel-default panel  panel-open" id="info" >
            <div role="tab"   class="panel-heading" onclick="showOrHide('info')" >
                <h4 class="panel-title">
                    <span ><i class="fa fa-chevron-down" aria-hidden="true"></i>文档基本信息(<font style="color:red">状态:<span id="status"></span></font>)</span>
                </h4>
            </div>
            <div   class="panel-collapse in collapse"  style="height: auto;">
                <div class="panel-body" id="infoBody">
                    <form id="fileMessage"  class="form-inline">
                        <table id="fileTable" style="" class="table_insert">
                            <tbody>
                            <tr>
                                <td class="tdtitle" align="right">文档编号：</td>
                                <td><input type="text" id="doc_id" name="doci_id"class="form_input" disabled="disabled"></td>

                                <td class="tdtitle" align="right">文档标题：</td>
                                <td><input type="text" id="doc_title" name="doc_title"class="form_input" disabled="disabled"></td>

                                <td class="tdtitle" align="right">归属机构：</td>
                                <td><input type="text" id="dept_name" name="dept_name" class="form_input" disabled="disabled"></td>

                            </tr>
                            <tr>
                                <td class="tdtitle" align="right">业务类型：</td>
                                <td><input type="text" id="service" name="service" class="form_input" disabled="disabled"></td>

                                <td class="tdtitle" align="right">提交人：</td>
                                <td><input type="text" id="user_name" name="user_name" class="form_input" disabled="disabled"></td>
                                <td class="tdtitle" align="right">提交时间：</td>
                                <td><input type="text" id="create_time" name="create_time" class="form_input" disabled="disabled"></td>


                            </tr>
                            <tr >
                                <td class="tdtitle" align="right">上一步办理状态：</td>
                                <td>
                                    <input type="text" id="last_status" name="last_status" class="form_input" disabled="disabled">
                                    <input type="hidden" id="statusz" name="statusz" class="form_input" disabled="disabled">
                                </td>

                                <td class="tdtitle" align="right">上一步办理时间：</td>
                                <td><input type="text" id="last_time" name="last_time" class="form_input" disabled="disabled"></td>

                                <td class="tdtitle" align="right">请求份数：</td>
                                <td><input type="text" id="max_num" name="max_num" class="form_input" disabled="disabled"></td>

                            </tr>
                            <tr >
                                <td class="tdtitle" align="right">前办理人：</td>
                                <td><input type="text" id="deal_user" name="deal_user" class="form_input" disabled="disabled"></td>

                                <td class="tdtitle" align="right">已打印份数：</td>
                                <td><input type="text" id="cur_num" name="cur_num" class="form_input" disabled="disabled"></td>

                                <td class="tdtitle" align="right">打印机构：</td>
                                <td><input type="text" id="print_dept" name="print_dept" class="form_input" disabled="disabled"></td>

                            </tr>
                            <tr >
                                <td class="tdtitle" align="right">当前办理人：</td>
                                <td colspan="3">
                                    <input type="hidden" id="userId_now" name="userId_now">
                                    <input type="hidden" id="fileBase64" name="fileBase64">
                                    <input type="hidden" id="addma" name="addma">
                                    <input type="hidden" id="download" name="download">
                                    <input type="text" id="user_now" name="user_now" class="form_input" disabled="disabled">
                                </td>


                                <td class="tdtitle" align="right">转呈机构：</td>
                                <td><select id="check_id" name="check_id"
                                            class="form_input" >
                                    <option value="0">总部</option>
                                    <option value="1">中心</option>
                                </select></td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>
        </div>
        <div class="panel panel-default" id="opinion" >
            <div  class="panel-heading"  onclick="showOrHide('opinion')">
                <h4 class="panel-title">
                    <span ><i class="fa fa-chevron-right" aria-hidden="true"></i>显示/隐藏审核意见列表</span>
                </h4>
            </div>
            <div class="panel-body" id="opinionBody" style="display: none">
                <div style="text-align: center">此文档无审核意见!</div>
            </div>
        </div>

        <div class="panel panel-default" id="newOpinion">
            <div class="panel-body" >
                <div id="renumberDiv" style="display:none">
                    <span style="width: 10%;text-align: right;display: inline-block;">申请分数：</span>
                    <input type="text" id="renumber" name="renumber" class="form_input" >
                    <span style="width: 10%;text-align: right;display: none;" id="workflow">选择流程：</span>
                    <select id="workflow_id" name="workflow_id" style="display: none" class="form_input" >
                        <option></option>
                    </select>
                </div>
                <span style="width: 10%;text-align: right;display: inline-block;">当前意见：</span>
                <textarea type="text" id="approve_opinion" name="approve_opinion" class="form_input" style="width: 70%;height: 30px;margin-bottom: 0px"></textarea>


                <span style="width: 8%;text-align: right;display: inline-block;">常用语：</span>
                <select id="commonLanguage" name="commonLanguage" class="form_input" style="width: 8%;">
                    <option></option>
                    <option value="通过！">通过！</option>
                    <option value="拒绝！">拒绝！</option>
                    <option value="退回！">退回！</option>

                </select>
            </div>
        </div>
        <div class="panel panel-default" id="set_doc_dept" style="display: none;">
            <div class="panel-body" >
                <table class="table_insert">
                    <tr>
                        <td class="tdtitle" align="right" style="width:10%;">阅读部门：</td>
                        <td><select id="save_set" name="save_set"
                                    class="form_input" >
                            <option></option>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="panel panel-default" >
            <div role="tab"   class="panel-heading" >
                <h4 class="panel-title">
                    <span><span >正文：</span><i class="pull-right glyphicon  glyphicon-chevron-down" ></i> </span>
                </h4>
            </div>
            <div style="background:#fff;">
                <div id="aip" name="aip" class="panel-body" >

                </div>
                <div name="listall" id="listall" class="panel-body" style="display:none;">
                    <textarea name="listallvalue" id="listallvalue" style="width:100%;height:100px;"></textarea>
                </div>
            </div>
        </div>


    </div>




    <script type="text/javascript">
        var services;
        var statusType=["起草","审核","盖章","打印","已归档","补打申请","已归档","退回"];
        var approve_status=["起草","审核","盖章","打印","归档","补打申请","归档","退回"];
        var urlPath=getUrlPath();
        var fromPage="";
        var filePath="";
        var docData="";
        var submitby="";//1是自动盖章提交，2是手动盖章提交
        //创建控件对象
        var hwpobj =new HWPostil("aip");
        //初始化控件
        hwpobj.Init({id:"HWPostil2",designMode:1,showMenu:0,showScrollBar:0,});
        hwpobj.setSilentMode(1);
        hwpobj.setShowDefMenu(0);
        hwpobj.setShowToolBar(0);

        //加载jqGrid
        var id="";
        $(document).ready(function() {
            $("#aip").height(500);
            id=GetQueryString("id");
            submitby=GetQueryString("submitby");
            //console.log("submitby"+submitby);
            fromPage=GetQueryString("fromPage");

            if(fromPage=="makeup"){
                $("#renumberDiv").show();
                getWorkflow();
            }else if(fromPage=="makeupApprove"){
                $("#renumberDiv").show();
            }else if(fromPage=="archiveManage"){
                conditionInit();
                $("#newOpinion").hide();
                $("#set_doc_dept").show();
            }

            informationInit(id);
        });
        function getWorkflow(){
            $.ajax({
                type : "GET",
                url : urlPath + "/workflow/getGzlc?djlxbm=008&noCache=" + new Date().getTime(),
                contentType : "application/json",
                dataType : "json",
                success : function(data) {
                    $("#workflow_id").show();
                    $("#workflow").show();
                    if(data!=null){
                        var sHtml="<option></option>";
                        for (var i = 0; i < data.length; i++) {
                            sHtml+="<option value="+data[i].gzlid+">" + data[i].gzlmc+"</option>";
                        }
                        $("#workflow_id").html(sHtml);
                    }


                },
                error : function(data) {

                }
            });
        }
        function GetQueryString(name){
            var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if(r!=null)return  decodeURI(r[2]); return null;
        }
        function informationInit(id) {

            $.ajax({
                type : "GET",
                url : urlPath + "/files/"+id+"?noCache=" + new Date().getTime(),
                contentType : "application/json",
                dataType : "json",
                success : function(data) {
                    //console.log(data);
                    if(data!=null){
                        docData = data;
                        $("#doc_id").val(data.doc_id);
                        $("#addma").val(data.addma);
                        $("#download").val(data.download);
                        $("#doc_title").val(data.doc_title);
                        $("#dept_name").val(data.dept_name);
                        $("#service").val(data.serv_name);
                        $("#user_name").val(data.user_name);
                        $("#create_time").val(new Date(data.created_at*1000
                        ).toLocaleString());
                        $("#last_status").val(statusType[data.last_status*1]);
                        $("#last_time").val(new Date(data.updated_at*1000).toLocaleString());
                        $("#max_num").val(data.max_num);
                        $("#deal_user").val(data.seal_user_name);
                        $("#cur_num").val(data.cur_num);
                        $("#print_dept").val(data.print_deptName);
                        $("#userId_now").val(data.now_login_user.loginId);
                        $("#user_now").val(data.now_login_user.name);
                        $("#save_set").val(data.save_set);
                        $("#status").html(statusType[data.status*1]);
                        $("#statusz").val(data.status);
                        //console.log("statusz="+data.status*1);
                        $("#status2").html(statusType[data.status*1]);
                        if(fromPage=="makeupApprove"){
                            $("#renumber").val(data.renumber);
                            $("#renumber").attr("disabled","disabled");

                        }
                        var approve_opinion=data.approve_opinion;
                        if(approve_opinion!=null&&approve_opinion.length>0){
                            $("#opinionBody").html("");
                            var resultString='';
                            for(var i=0;i<approve_opinion.length;i++){
                                var opinion=approve_opinion[i];
                                resultString+='<div>【'+opinion.user_name+'&nbsp&nbsp'+new Date(opinion.add_time).toLocaleString('china')+'&nbsp&nbsp'+approve_status[opinion.make_type]+'】:'+opinion.app_data+'</div>';
                            }
                            $("#opinionBody").append(resultString);
                        }

                        if(data.base64!=null && data.base64!=""){
                            filePath = data.filePath+"\\"+data.doc_id+"."+"pdf";
                            hwpobj.LoadFileBase64(data.base64);
                        }

                    }
                },
                error : function(data) {

                }
            });
        }
        Date.prototype.toLocaleString = function() {
            var currMonth = (this.getMonth() + 1) < 10 ? '0'+(this.getMonth() + 1):(this.getMonth() + 1);
            var currDate = this.getDate() < 10 ? '0'+this.getDate():this.getDate();
            var currHours = this.getHours() < 10 ? '0'+this.getHours():this.getHours();
            var currMinutes = this.getMinutes() < 10 ? '0'+this.getMinutes():this.getMinutes();
            var currSeconds = this.getSeconds() < 10 ? '0'+this.getSeconds():this.getSeconds();

            return this.getFullYear() + "-" + currMonth + "-" + currDate + " " + currHours + ":" + currMinutes + ":" + currSeconds;
        };

        function showOrHide(id){
            var element="#"+id+" .panel-heading .panel-title span i";
            if($(element).hasClass("fa-chevron-right")){
                $(element).addClass("fa-chevron-down");
                $(element).removeClass("fa-chevron-right");
            }else{
                $(element).removeClass("fa-chevron-down");
                $(element).addClass("fa-chevron-right");

            }
            $("#"+id+"Body").toggle(300);

        }
        $("#commonLanguage").change(function (){
            $("#approve_opinion").val($("#commonLanguage").val());
        });

        function getData(operate){
          /*  if("2"==submitby){*/
                //console.log("文档退回2");
                var data={};
                var statusz=$("#statusz").val();
                 data['status']=statusz;
                var approve_opinion=$("#approve_opinion").val();
                if(approve_opinion!=""){
                    data['approve_opinion']=approve_opinion;
                }else{
                    //console.log("文档退回2,审核意见不能为空"+approve_opinion);
                    layer.msg("审核意见不能为空!",{offset:'100px'});
                    return null;
                }
                //console.log("是否执行");
                var num = hwpobj.getNoteNum(3);
                //console.log("num"+num);

                if(operate == "submit"){
                    if(num == 0){
                        layer.msg("文件未盖章",{offset:'100px'});
                        return null;
                    }
                    var res = new Object();
                    res["created_at"] = docData.created_at;
                    res["doc_id"] = docData.doc_id;
                    var updoc = hwpobj.savePdfToServer(urlPath+'/files/savePdfToServer?noCache='+new Date().getTime(),"lifeFile",res);
                    var upstatus = JSON.parse(updoc);
                    if(upstatus.code != 200){
                        layer.msg("上传失败",{offset:'100px'});
                        return null;
                    }
                }else if(operate == "docback"){
                    //console.log("文档已经盖章");
                    if(num > 0){
                        layer.msg("文档已有印章信息不能退回",{offset:'100px'});
                        return null;
                    }
                }else if(operate == "autodata"){
                    //console.log("文档已经盖章");
                    if(num > 0){
                        layer.msg("文档已有印章信息，请手动加盖",{offset:'100px'});
                        return null;
                    }
                }

                var doc_id=$("#doc_id").val();
                data['doc_id']=doc_id;
                data['sealnum']=num;
                if(fromPage=="makeup"){
                    data['renumber']=$("#renumber").val();
                    data['workflow_id']=$("#workflow_id").val();
                }else if(fromPage=="archiveManage"){
                    data['save_set']=$("#save_set").val();
                }
                data['addma']=$("#addma").val();
                //console.log(data);
                return data;
            /*}else{
                var doc_id=$("#doc_id").val();
               var message=sbumitUpdateStatus(doc_id);
               console.log("message"+message);
               return message;
            }*/

        }

        function sbumitUpdateStatus(doc_id) {
            var idArr=new Array();
            idArr.push(doc_id);
            var resultdata="";
            $.ajax({
                type: "POST",
                url: urlPath + "/files/submitUpdateStatus",
                data: JSON.stringify(idArr),
                async:false,
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    resultdata="提交成功！";
                },
                error:function(XMLHttpRequest, textStatus, errorThrown){
                    resultdata="提交失败！";
                }
            });
            //console.log("resultdata"+resultdata);
            return resultdata;

        }
        function conditionInit() {
            $.ajax({
                type : "GET",
                url : urlPath + "/files/conditionInit?noCache=" + new Date().getTime(),
                contentType : "application/json",
                dataType : "json",
                success : function(data) {

                    var departments=data.departments;
                    for (var i = 0; i < departments.length; i++) {
                        $("#save_set").append("<option value="+departments[i].id+">" + departments[i].name+"</option>");

                    }
                },
                error : function(data) {

                }
            });
        }

        //手动盖章
        function sealagin(){
            var ret = hwpobj.LoginRet("",3,65535,"",urlPath+"/serviceForAip/");
            if(ret == -200){
                parent.layer.msg("未发现智能卡",{offset:'100px'});
            }else if(ret != 0){
                parent.layer.msg("登录失败。请确认服务器状态或智能卡是否正确！"+ret+"",{offset:'100px'});
                return false;
            }
            hwpobj.ActAddSeal();
        }

        //清章
        function sealclear(){
            var userid = hwpobj.GetCurrUserID();
            var sealid=hwpobj.GetNextNote(userid, 0, "");
            while (sealid!=""){
                var sealidnext=hwpobj.GetNextNote(userid, 0, sealid);
                hwpobj.DeleteNote(sealid);
                sealid=sealidnext;
            }
        }



        function getDocid(){
            return id;
        }

        function haveaddsealdocreturn(){
            var num = hwpobj.getNoteNum(3);
            var flag="1";
            if(num>0){
                flag="2";
            }else{
                layer.msg("文档未加盖印章",{offset:'100px'});
            }
            return flag;
        }

        function haveaddsealdocreturnforautoseal(){
            var num = hwpobj.getNoteNum(3);
            var flag="2";
            if(num>0){
                flag="1";
                layer.msg("文档已加盖印章",{offset:'100px'});
            }
            return flag;
        }
        


    </SCRIPT>
</body>
</html>