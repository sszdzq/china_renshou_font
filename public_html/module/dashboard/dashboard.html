<!DOCTYPE html>
<html>
	<head>
		<META HTTP-EQUIV="Pragma" CONTENT="no-cache"><META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
		<meta http-equiv="X-UA-Compatible" content="IE=9" />
		<!--导入jquery文件-->
		<script type="text/javascript" src="../../shared/html5/html5shiv.min.js"></script>
		<script type="text/javascript" src="../../shared/respond/respond.src.js"></script>
		<!-- <script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script> -->
		<script src="../../shared/js/jquery-1.9.1.min.js" type="text/javascript"></script>
		<script src="../../shared/js/jquery.extend.min.js" type="text/javascript"></script>
		<script src="../../shared/js/myLayer.js" type="text/javascript"></script>
		<script src="../../shared/layer/layer.js" type="text/javascript"></script>
		<!--导入bootstrap.css文件-->
		<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.min.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap-table.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/index-ess.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/font-awesome.min.css"  type="text/css" />
		<!--导入bootstrap.js文件-->
		<script type="text/javascript" src="../../shared/bootstrap/js/bootstrap.min.js" ></script>
		<!--创建视口-->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- jqgridjs -->
		<script src="../../shared/jqgrid/js/jquery.jqGrid.min.js" type="text/javascript"></script>
		<script src="../../shared/jqgrid/js/jquery.jqGrid.extend.js" type="text/javascript"></script>
		<script type="text/javascript" src="../../shared/jqgrid/js/i18n/grid.locale-cn.js"></script>
		<!-- echart组件 -->
		<script src="../../shared/plugins/echarts.min.js" type="text/javascript"></script>
		<script src="../../shared/plugins/utils.js" type="text/javascript"></script>
		<style>
			.shadow{height:100%;width:100%;}
			.shadow:hover{background-color: rgb(250,250,250);box-shadow: 0 0 12px 	#505050;opacity: 1;}
		</style>
	</head>
	<body>
		<!--创建布局容器-->
		<div class="container-fluid" style="margin:0 10px 0 10px;">
			<div class="clearfix"></div>
				<div class="row-fluid" style="margin-top:30px;font-size:18px;background:white;">
					<div class="span3 text-center" style="height:200px;border-right:1px solid #E9E9E9;">
						<div><img src="../../shared/images/assets/headPortrait/Fruit-2.png" style="margin-left:0px;width:110px;height:110px;margin-top:30px;border-radius:50%; overflow:hidden;"/></div>
						<p id="usernameP" style="margin-top:30px"></p>
					</div>
					<div class="span5" style="height:200px;border-right:1px solid #E9E9E9">
						<p id="departmentP" style="margin-top:40px"></p>
						<p id="roleNameP" style="margin-top:15px"></p>
						<p id="lastLoginTimeP" style="margin-top:15px"></p>
					</div>
					<div class="span4" style="height:200px;">
						<p id="emailP" style="margin-top:40px"></p>
						<p id="mobileP" style="margin-top:15px"></p>
						<p id="workTelephoneP" style="margin-top:15px"></p>
					</div>
								
				
				</div>
				<div class="row-fluid" style="margin-top:40px;" >						
					<div id="moulageManage" onclick="openMoluge()" class="span3 text-center" style="background:white;height:400px;cursor: pointer;display:none;">
					<div class="shadow">
						<div ><img src="../../shared/images/assets/images/dashboard_seal_blue.png" style="width:120px;height:120px;margin-top:100px;"/></div>
						<div>
						<p style="font-size:18px;margin-left:15px;margin-top:50px;">
							<b>印模管理<span id="moulageCountSpan" style="color:blue;margin:0 15px 0 15px"></span>个</b>
						</p>
						</div>
					</div>
					</div>
					<div id="sealManage" onclick="openSeal()" class="span3 text-center" style="background:white;height:400px;cursor: pointer;display:none;">
						<div class="shadow">
						<div><img src="../../shared/images/assets/images/dashboard_seal_green.png" style="width:120px;height:120px;margin-top:100px;"/></div>
						<p style="font-size:18px;margin-left:5px;margin-top:50px;">
							<b>印章管理<span id="sealCountSpan" style="color:green;margin:0 15px 0 15px"></span>个</b>
						</p>
						</div>
					</div>					
					<div id="loginUsersChart" class="span3 text-center" style="background:white;height:400px;display:none;padding-right:20px;">						
					</div>	
									
					<div id="moulageChart" class="span3 text-center" style="background:white;height:400px;display:none;padding-right:20px;">
					</div>	
					
				</div>
				<div id="userCollect" style="margin-top:50px;display:none;">
					<ul id="tab_1" class="nav nav-pills" >							    
					    <li id="dayUser" node-data="tab_day_user" class="active"  onclick="getCountData('day','userCollectInfo')"><a data-toggle="tab" href="#tab_task">24小时内登录用户</a></li>
					    <li id="monthUser" node-data="tab_month_user"  onclick="getCountData('month','userCollectInfo')"><a data-toggle="tab" href="#tab_workhour">1个月内登录用户</a></li>
					    <li id="yearUser" node-data="tab_year_user"  onclick="getCountData('year','userCollectInfo')"><a data-toggle="tab" href="#tab_checkin">1年内登录用户</a></li>					    
					</ul>
					<div style="clear:both"></div>	
					<div id="userCollectInfo" class="tab-pane"  style="height:300px;background:white;">
					</div>																																	
				</div>
				<div id="userListTable" style="margin:50px 0 50px 0;display:none">
					<ul id="tab_1" class="nav nav-pills" style="margin-bottom:-40px;">							    
					    <li id="userList" node-data="tab_user_list" class="active"  ><a data-toggle="tab" href="#tab_task">当前登录用户</a></li>
					</ul>
					<div style="clear:both"></div>
					<table id="userTable">
	                </table>																																		
				</div>
				<div id="sealCollect" style="display:none;">
					<ul id="tab_3" class="nav nav-pills" >							    
					    <li id="daySeal" node-data="tab_day_seal" class="active"  onclick="getCountData('day','sealCollectInfo')"><a data-toggle="tab" href="#tab_task">24小时内印章使用</a></li>
					    <li id="monthSeal" node-data="tab_month_seal"  onclick="getCountData('month','sealCollectInfo')"><a data-toggle="tab" href="#tab_workhour">1个月内印章使用</a></li>
					    <li id="yearSeal" node-data="tab_year_seal"  onclick="getCountData('year','sealCollectInfo')"><a data-toggle="tab" href="#tab_checkin">1年内印章使用</a></li>					    
					</ul>
					<div style="clear:both"></div>	
					<div id="sealCollectInfo" class="tab-pane"  style="height:300px;background:white;">
					</div>																																	
				</div>
				
		</div>
	</body>
	<script src="../../shared/bootstrap/js/bootstrap-table.js" type="text/javascript"></script>
	<script src="../../shared/bootstrap/js/bootstrap-table-zh-CN.js" type="text/javascript"></script>		
<script type="text/javascript">
jQuery.support.cors = true;
   //图表定义
   var myPieChart = null;
   var pieOption = null;
   var myLineChart = null;
   var lineOption = null;
   //当前登录用户id  
   var currUserId = null;
   var showOrNot = {
		      userCollectInfo : false,
		      sealCollectInfo : false
		    };
   var aipUrl = getUrlPath();

   
	$(document).ready(function() {
	    getUserinfo();
	    getCountData('day','userCollectInfo');
	    getCountData('day','sealCollectInfo'); 
	});



   
   function getUserinfo(){
		$.ajax({
			type : "GET",
			data :{},
			url : aipUrl+'/userInfo?noCache='+new Date().getTime(),
			dataType : "json",
			async:false,
			success : function(data) {
				currUserId = data.id;
				window.parent.document.getElementById("userLayer").innerHTML='<i class="fa fa-user" style="margin-right:10px"></i>' + (data.name?data.name:data.username);
				var lastloginTimeStr = null;
				if(data.lastloginTime != null){
					var unixTimestamp = new Date((data.lastloginTime)*1000) ;
					lastloginTimeStr = unixTimestamp.toLocaleString();					
				}
				var depart =data.department.allName + (data.lowerLevel? '(' : '(不') + '包含下级)';
				var roleName = data.roleName;
				if(roleName.length >= 24){
					roleName = roleName.substring(0,24)+'...';
				}
				document.getElementById("usernameP").innerHTML=data.name?data.name:data.username;
				document.getElementById("departmentP").innerHTML='<i class="fa fa-sitemap" style="margin-right:10px"> </i><b>所属单位 :</b> '+depart;
				document.getElementById("roleNameP").innerHTML='<i class="fa fa-user" style="margin-right:10px"></i><b>身份角色 :</b> '+roleName;
				document.getElementById("lastLoginTimeP").innerHTML='<i class="fa fa-user-secret" style="margin-right:10px"></i><b>上次登陆时间 :</b> '+(data.lastloginTime == 'null'?'未登录':lastloginTimeStr);
				document.getElementById("emailP").innerHTML='<i class="fa fa-envelope" style="margin-right:10px"></i><b>邮箱 :</b> '+(data.email == null?'':data.email);
				document.getElementById("mobileP").innerHTML='<i class="fa fa-mobile" style="margin-right:10px"></i><b>手机号码 :</b> '+(data.mobile == null?'':data.mobile);
				document.getElementById("workTelephoneP").innerHTML='<i class="fa fa-phone" style="margin-right:10px"></i><b>办公电话 :</b> '+(data.workTelephone == null?'':data.workTelephone);
			},
			error : function(xmlhttp,textStatus,errorThrown){
				////console.log(xmlhttp);
			}
		});
   }
   
   Date.prototype.toLocaleString = function() {
	   var currMonth = (this.getMonth() + 1) < 10 ? '0'+(this.getMonth() + 1):(this.getMonth() + 1);
	   var currDate = this.getDate() < 10 ? '0'+this.getDate():this.getDate();
	   var currHours = this.getHours() < 10 ? '0'+this.getHours():this.getHours();
	   var currMinutes = this.getMinutes() < 10 ? '0'+this.getMinutes():this.getMinutes();
	   var currSeconds = this.getSeconds() < 10 ? '0'+this.getSeconds():this.getSeconds();

       return this.getFullYear() + "-" + currMonth + "-" + currDate + " " + currHours + ":" + currMinutes + ":" + currSeconds;
   };
   
   function openMoluge(){
		var obj=new Object();
		obj.innerHTML="印模管理";
		parent.parent.gotoNav('5','../../module/mold/manage.html',obj);
   }
   function openSeal(){
		var obj=new Object();
		obj.innerHTML="印章管理";
		parent.parent.gotoNav('13','../../module/seal/manage.html',obj);
   }
   
   function kick(userId){
	   var ids = [];
	   ids.push(userId);
		layer.confirm('确实要踢出此用户吗?', {
			  btn: ['确定','取消']
		}, function(){
			$.ajax({
				type : "PUT",
				url : aipUrl+"/logoutUsers",
				data : JSON.stringify(ids),
				dataType : "json",
				contentType:"application/json",
				success : function(retdata) {
					//layer.msg('用户踢出成功', {icon: 1});
					location.reload();
				}
			});
		});
   }
   
   function setTable(users){
		$('#userTable').bootstrapTable({
			cache: false,
			height: '100%',
			striped: true,
			//sortName:'loginId',
			sortable: true, //排序方式
			undefinedText:"无",
			pageSize: 10,
			pageNumber:1,
			pageList: [10, 25, 50, 100], 
			pagination: true,
			paginationPreText: "上一页",
            paginationNextText: "下一页",
			sidePagination:'client',
			smartDisplay:false,
			search: true,
			showColumns: false,
			showRefresh: false,
			showExport: false,
			search: true,
			clickToSelect: true,
			columns: 
			[
				{field:"loginId",title:"用户名",width:"15%",align:"left",valign:"left",sortable:"true"},
				{field:"name",title:"用户姓名",width:"15%",align:"left",valign:"left",sortable:"true"},
				{field:"department",title:"所属部门",width:"15%",align:"left",valign:"left",sortable:"true"},
				{field:"phone",title:"手机号",width:"15%",align:"left",valign:"left",sortable:"true"},
				{field:"dostTime",title:"最后操作时间",width:"26%",align:"left",valign:"left",sortable:"true"},
				{field:"id",title:"操作",width:"10%",align:"left",valign:"left",sortable:"false",formatter:function(value,row,index){
                   	var kickStr = '';
                   	if(value != currUserId){
                   		kickStr = '<a href="javascript:void(0)" onclick="kick(\''+value+'\')">踢出</a>';
                   	}
					return kickStr;
                }},
			],
			data:users
		});				
   }
   
    function getCountData(dateType,countType){
		$.ajax({
			type : "GET",
			data :{type : dateType},
			url : aipUrl+"/"+countType+"?noCache="+new Date().getTime(),
			dataType : "json",
			async:false,
			success : function(data) {
				showOrNot.countType = true;
				if(showOrNot.countType && countType == 'sealCollectInfo'){
					document.getElementById('sealCollect').style.display="block";
					document.getElementById('sealManage').style.display="block";
					document.getElementById('moulageManage').style.display="block";
					document.getElementById('moulageChart').style.display="block";
				}else if(showOrNot.countType && countType == 'userCollectInfo'){
					document.getElementById('userCollect').style.display="block";
					document.getElementById('loginUsersChart').style.display="block";
					document.getElementById('userListTable').style.display="block";
				}
 	          if(countType == 'userCollectInfo'){
 	        	getConfig(1,'当前登录用户'); 
 	        	getConfig(0,"用户数");
	            var loginUsersCount = data.loginUsersCount;
	            var notLoginUsersCount  = data.userCount - loginUsersCount;
	            pieOption.series[0].data = [];
	            pieOption.series[0].data[0] = {value:loginUsersCount === null? 0:loginUsersCount,name:"登录用户"};
	            pieOption.series[0].data[1] = {value:notLoginUsersCount === null? 0:notLoginUsersCount,name:"未登录用户"};
	            myPieChart.setOption(pieOption);
	            
	            var users = data.loginUsersName;
	            for(var i = 0,len = users.length; i < len; i++){
	            	var dostTimeStr = null
					if(users[i].dostTime != null){
						var unixTimestamp = new Date((users[i].dostTime)) ;
						dostTimeStr = unixTimestamp.toLocaleString();
						users[i].dostTime = dostTimeStr;
					}
	            }
	            setTable(users);
	          }else if(countType == 'sealCollectInfo'){
	        	  getConfig(0,"印章数");
	        	  getConfig(1,'印模'); 
	              var moulageInfo = data.moulageInfo;
	              pieOption.series[0].data = [];
	              pieOption.series[0].data[0] = {name:"未审批", value:moulageInfo[0] === null? 0:moulageInfo[0]};
	              pieOption.series[0].data[1] = {name:"已通过", value:moulageInfo[1] === null? 0:moulageInfo[1]};
	              pieOption.series[0].data[2] = {name:"未通过", value:moulageInfo[2] === null? 0:moulageInfo[2]};
	              myPieChart.setOption(pieOption);
	              var sealCount = data.sealCount;
	              var moulageCount = moulageInfo[0]+moulageInfo[1]+moulageInfo[2];	              
	              document.getElementById("moulageCountSpan").innerHTML = moulageCount;
	              document.getElementById("sealCountSpan").innerHTML = sealCount;
	          }
			  getCollectInfo(dateType,countType,data);
			}
		});
      }
    
    function getConfig(type,p){
        switch (type) {
        case 0:
         	var lineChartObj = '';
        	if(p == '用户数'){
        		lineChartObj = 'userCollectInfo';
        	}else if(p == '印章数'){
        		lineChartObj = 'sealCollectInfo';
        	}
        	
        	myLineChart = echarts.init(document.getElementById(lineChartObj)); 
        	lineOption = {
            	    tooltip : {
            	        trigger: 'item',
            	        formatter:'{a}:{c}',
            	        backgroundColor:"rgba(248,248,255,0.7)", 
            	        borderColor: '#1E90FF',
            	        borderWidth: 1,
            	        position: function(point, params, dom) {
                            return [point[0]-50, point[1]-60];
                        },
            	        textStyle: {
            	            color: 'black'
            	        }
            	    },
            	    toolbox: {  
                        //show: true,  
                        itemSize: 20,  
                        itemGap: 30,  
                        right: 10,  
                        feature: {  
                            dataView: {show:true},  
                            saveAsImage: {  
                                //excludeComponents :['toolbox'],  
                                pixelRatio: 2  
                            }  
                        }  
           			 },
        		    xAxis: {
        		        type: 'category',
        		        data:[]
        		    },
        		    yAxis: {
        		        type: 'value',
        		        minInterval:1
        		    },
        		    series: [{
        		    	name:p,
        		        type: 'line',
                        symbol:'circle',//拐点样式
                        symbolSize: 8,//拐点大小
        		        data:[],
        		        itemStyle: {
        		            normal: {
        		                color: "#1E90FF",
        		                lineStyle: {
        		                	width:2,
        		                    color: "#1E90FF"
        		                }
        		            }
        		        },
        		    }]
        		};
        	 
        case 1:
        	var pieObj = '';
        	if(p == '当前登录用户'){
        		pieChartObj = 'loginUsersChart';
        	}else if(p == '印模'){
        		pieChartObj = 'moulageChart';
        	}
        	myPieChart = echarts.init(document.getElementById(pieChartObj));  
            pieOption = {
            	    title : {
        	            text:  p +'统计',
        	            align: 'left',
        	            floating: false,
        	            x: 10,
        	            y: 10,
        	            textStyle: {
        	                fontSize: 18,
        	                fontWeight: 'normal',
        	                color: '#333'          // 主标题文字颜色
        	            },
        	        },
            	    tooltip : {
            	        trigger: 'item',
            	        formatter:'{b}<br/>占 : <b>{d}%</b>',
            	        backgroundColor:"rgba(248,248,255,0.7)", 
            	        borderColor: '#D8BFD8',
            	        borderWidth: 1,
            	        position: function(point, params, dom) {
                            return [point[0]-50, point[1]-60];
                        },
            	        textStyle: {
            	            color: 'black'
            	        }
            	    },
            	    toolbox: {  
                        //show: true,  
                        itemSize: 20,  
                        itemGap: 30,  
                        right: 10,  
                        feature: {  
                            dataView: {show:true},  
                            saveAsImage: {  
                                //excludeComponents :['toolbox'],  
                                pixelRatio: 2  
                            }  
                        }  
           			 },
            	    series : [
            	              {
            	                  name: '',
            	                  type: 'pie',
            	                  radius : '35%',
            	                  center: ['50%', '60%'],
            	                  itemStyle: {
            	                      emphasis: {
            	                          shadowBlur: 10,
            	                          shadowOffsetX: 0,
            	                          shadowColor: 'rgba(0, 0, 0, 0.7)'
            	                      },
            	                      normal: {
            	                          label: {        //此处为指示线文字
            	                              show: true,
            	                              position: 'top', //标签的位置
            	                              textStyle: {
            	                            	  color:'black',
            	                                  fontWeight: 'bolder',
            	                                  fontSize: 11    //文字的字体大小
            	                              }
            	                          },
             	                          labelLine: {    //指示线状态
            	                              show: true,
            	                              smooth: 1,
            	                              length: 13
            	                          } 
            	                      }
            	             	  }
            	              }
            	          ],
            	     color: ['#3498db', '#2ecc71', '#f1c40f', '#f39c12', '#9b59b6', '#c0392b', '#1abc9c', '#d35400', '#bdc3c7', '#34495e', '#7f8c8d', '#16a085', '#27ae60', '#e74c3c', '#8e44ad', '#2980b9', '#95a5a6', '#2c3e50']
                };
       }
     }
    
       function getCollectInfo(dateType,countType,data){
    	
        var thisHour = new Date().getHours();
        var today = new Date().getDate();
        var thisMonth = new Date().getMonth() + 1;
        var lastMonth = new Date().getMonth() == 0? 12 : new Date().getMonth();
        var historyInfo = data.historyInfo;
         if(dateType == 'day'){
          lineOption.series[0].data = [];
          for(var h = 1;h<=24;h++){
        	  lineOption.xAxis.data.push((h+thisHour)%24+'时');
        	  lineOption.series[0].data[h-1] = (historyInfo[(h+thisHour)%24] === null? 0 : historyInfo[(h+thisHour)%24]);
          }
          myLineChart.setOption(lineOption);
        }else if(dateType == 'month'){
          var allDays = 0;
          var d, ds = [], mds=[];
          lastMonth = (lastMonth < 10 ? "0" : "") + lastMonth;
          thisMonth = (thisMonth < 10 ? "0" : "") + thisMonth;
          for(d = 31;d >= 28;d--){
            if(historyInfo[(lastMonth+ "" + d)] !== undefined){
              allDays = d;
              break;
            }
          }
          for(d = 0;d < 30;d++){
            var day = today - d;
            if(day > 0){
              ds.push(thisMonth + (day < 10 ? "0" : "") + day);
              mds.push(parseInt(thisMonth,10) + "月" + day + "日");
            }else{
              day += allDays;
              ds.push(lastMonth + (day < 10 ? "0" : "") + day);
              mds.push(parseInt(lastMonth,10) + "月" + day + "日");
            }
          }
          lineOption.series[0].data = [];
          for(d = 29;d >= 0;d--){
            lineOption.xAxis.data.push(mds[d]);
            lineOption.series[0].data[29 - d] = (historyInfo[ds[d]] === null? 0 : historyInfo[ds[d]]);
          }
          myLineChart.setOption(lineOption);
        }else{
        	lineOption.series[0].data = [];
            for(var m = 0;m<12;m++){
              lineOption.xAxis.data.push((m+thisMonth)%12+1+'月');
              lineOption.series[0].data[m] = (historyInfo[(m+thisMonth)%12+1] === null? 0 : historyInfo[(m+thisMonth)%12+1]);
            }  
            myLineChart.setOption(lineOption);
        }
      } 
    
    
	</script>
</html>
