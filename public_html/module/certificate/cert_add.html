<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>添加证书</title>
<style type="text/css">
	label {
	display: inline-block;
	max-width: 100%;
	margin-bottom: 5px;
	/* font-weight: bold; */
	margin-right: 8px;
}

</style>
	<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.min.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/index-ess.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/font-awesome.min.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/document.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/dj-bootstrap.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/dj-tab.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/css/main.css"  type="text/css" />
		<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.css"  type="text/css" />
	    <!-- jqgrid样式 -->
	    <link href="../../shared/jqgrid/css/ui.jqgrid.css" type="text/css"  rel="stylesheet" />
	    <link href="../../shared/jqgrid/css/css/flick/jquery-ui-1.8.16.custom.css" type="text/css"  rel="stylesheet" />
	    
	    
	    	<!--javascript引用部分 -->
	   <script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script>
<script src="../../shared/js/jquery.extend.js" type="text/javascript"></script>	   <script src="../../shared/js/myLayer.js" type="text/javascript"></script>
	   <script src="../../shared/ztree/js/jquery.ztree.core.min.js" type="text/javascript"></script>
	   
		<!-- jqgridjs -->
	    <script src="../../shared/jqgrid/js/jquery.jqGrid.min.js" type="text/javascript"></script>
	<script src="../../shared/jqgrid/js/jquery.jqGrid.extend.js" type="text/javascript"></script>
		<script type="text/javascript" src="../../shared/jqgrid/js/i18n/grid.locale-cn.js"></script>
		
		<script src="../../shared/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	    <script src="../../shared/layer/layer.js" type="text/javascript"></script>
	    
	    	<!-- my97 DatePicker  -->
	    <script src="../../shared/my97/WdatePicker.js" type="text/javascript"></script>	
	    <script src="../../shared/plugins/utils.js" type="text/javascript"></script>
	      <script type="text/javascript" src="../../shared/js/jquery-validate.js"></script>
	    <style type="text/css">
	.file {
    position: relative;
    display: inline-block;
    background: #D0EEFF;
    border: 1px solid #99D3F5;
    border-radius: 4px;
    padding: 4px 12px;
    overflow: hidden;
    color: #1E88C7;
    text-decoration: none;
    text-indent: 0;
    line-height: 20px;
}
.file input {
    position: absolute;
    font-size: 100px;
    right: 0;
    top: 0;
    opacity: 0;
}
.file:hover {
    background: #AADFFD;
    border-color: #78C3F3;
    color: #004974;
    text-decoration: none;
}
</style>
 <style type="text/css">
.valid_message{
color:#f00;
}

  </style>
</head>
<body>
	<form id="certForm" action="" class="form_control">
	<table id="certTable">
	<tr>
		<td>证书名称</td>
		<td>	<input id="certname" type="text" name="name" class="required" checkUrl="" data-tip="" data-valid="isNonEmpty||onlyOne" data-error="证书名称不能为空||证书名重复" maxlength="40" placeholder="请输入证书名称">
		</td>
	</tr>
	<tr>
		<td>来源类型</td>
		<td>	
			<select id="type"  style="" onchange="changeType()">
				<option value=""selected="selected">请选择...</option>
				<option label="服务器证书" value="0">服务器证书</option>
				<option label="加密机证书" value="1">加密机证书</option>
			</select>		
		</td>
	</tr>
	<tr id="zsmmTr">
		<td >证书密码</td>
		<td>	
			<input type="password" name="password" id="pwd" class="required" data-valid="isNonEmpty"  data-error="服务器密码不能为空" placeholder="请输入证书密码" style="">	
		</td>
	</tr>
	<tr id="zswjTr">
		<td>证书文件</td>
		<td>
			<button onclick="$('#fileField').click()" type="button" class="btn btn-info" >选择证书</button>
		<!-- 	<button onclick="getData()" type="button" class="btn btn-info" >选择1证书</button> -->
		<input type="file"  name="fileField" id="fileField" hidden="hidden" style="display:none" onchange="selectFile('fileField');" />	
	<!-- <div  id="textfield" style="display: inline-block;"  >
	
	</div> -->
	<input type="text" readonly="readonly" id="textfield" style="width: 20%"  class="required" data-valid="isNonEmpty||isPfxOrP12"  data-error="证书不能为空||证书格式错误"/>
	
		</td>
	</tr>
	<tr id="wjgsTr">
		<td>文件格式</td>
		<td>	
			<p style="padding-top: 8px">支持pfx,p12格式</p>	
		</td>
	</tr>
	<tr id="zslxTr">
		<td>证书类型</td>
		<td>	
			<select id="encryptionType" name="encryptionType" style="">
				<option value="" class="" selected="selected">请选择...</option>
				<option label="RSA" value="0">RSA</option>
			</select>
		</td>
	</tr>
	<tr id="zsbmTr">
		<td>证书别名</td>
		<td>	
			<input type="text" name="aliasName"  maxlength="200" placeholder="请输入证书别名">
		</td>
	</tr>
	<tr id="gywjTr">
		<td>证书文件</td>
		<td>	
		<button onclick="cerfile.click()"  type="button" class="btn btn-info ">选择证书公钥</button>
		<!-- 	<button onclick="getData()" type="button" class="btn btn-info" >选择1证书</button> -->
		<input type="file"  name="cerfile" id="cerfile" hidden="hidden" style="display:none" onchange="selectCerFile('cerfile');" />	
	<!-- <div  id="cerfield" style="display: inline-block;"></div> -->
		<input type="text" readonly="readonly" id="cerfield" style="width: 20%"  class="required" data-valid="isNonEmpty||isCer"  data-error="证书不能为空||证书格式错误"/>
		
		</td>
	</tr>
	<tr id="gygsTr">
		<td>证书公钥</td>
		<td>	
			<p style="padding-top: 8px">支持cer格式</p>	
		</td>
	</tr>
	</table>
	
	
	</form>

</body>
<script type="text/javascript">
var aipUrl = getUrlPath();
var resultStr="";
//初始化，用于验证输入数据是否符合要求
/* V.init("certForm","certTable"); */
	//页面加载函数
	$(function(){
		$("#certname").attr("checkUrl",aipUrl+"/cert_name");
		//隐藏服务器证书相关行
		$("#zsmmTr").hide();//证书密码
		$("#zswjTr").hide();//pfx,p12文件
		$("#wjgsTr").hide();//文件格式服务器
		//删除服务器class
		$("#pwd").removeAttr('class');
		$("#textfield").removeAttr('class');
		//删除加密机class
		$("#cerfield").removeAttr('class');
		//隐藏加密机证书相关列 
		$("#zslxTr").hide();//类型
		$("#zsbmTr").hide();//别名
		$("#gywjTr").hide();//证书文件cer
		$("#gygsTr").hide();//文件格式公钥
		
	
	})
	//改变来源状态
	function changeType(){
		var type=$("#type").val();
		if(type=='0'){
			//隐藏加密机证书相关列
			$("#zslxTr").hide();//类型
			$("#zsbmTr").hide();//别名
			$("#gywjTr").hide();//证书文件cer
			$("#gygsTr").hide();//文件格式公钥
			//删除加密机class
			$("#cerfield").removeAttr('class');
			//服务器证书展示
			$("#zsmmTr").show();
			$("#zswjTr").show();
			$("#wjgsTr").show();
			//增加服务器class
			$("#pwd").attr('class',"required");
			$("#textfield").attr('class',"required");
		}
		else if(type=='1'){
			//隐藏服务器证书相关行
			$("#zsmmTr").hide();//证书密码
			$("#zswjTr").hide();//pfx,p12文件
			$("#wjgsTr").hide();//文件格式服务器
			//展示加密机相关行
			$("#zslxTr").show();//类型
			$("#zsbmTr").show();//别名
			$("#gywjTr").show();//证书文件cer
			$("#gygsTr").show();//文件格式公钥
			//删除服务器class
			$("#pwd").removeAttr('class');
			$("#textfield").removeAttr('class');
			//增加加密机证书class
			$("#cerfield").attr('class',"required");
		}else{
			//隐藏服务器证书相关行
			$("#zsmmTr").hide();//证书密码
			$("#zswjTr").hide();//pfx,p12文件
			$("#wjgsTr").hide();//文件格式服务器
			//删除服务器class
			$("#pwd").removeAttr('class');
			$("#textfield").removeAttr('class');
			//删除加密机class
			$("#cerfield").removeAttr('class');
			//隐藏加密机证书相关列
			   
			$("#zslxTr").hide();//类型
			$("#zsbmTr").hide();//别名
			$("#gywjTr").hide();//证书文件cer
			$("#gygsTr").hide();//文件格式公钥
			
		}
	}
	//检查证书名是否存在
	function checkName(){
		var res={};
		res['field']='name';
		res['value']=$("#certname").val();
		  $.ajax({
				type : "get",
				url : aipUrl+"/cert_name",
				data : res,
				contentType:"application/json",
				dataType : "json",
				success : function(retdata) {
		
				},
		  		error: function(xmlhttp,textStatus,errorThrown){
		 				var o = JSON.parse(xmlhttp.responseText);
		 				layer.msg(o.message, {icon: 5});
		 		
		 			}
		  		
	
			});
	}
	//选择服务器证书
	function selectFile(id){
		var filePath=$("#"+id).val();
		//document.getElementById('textfield').append(filePath.slice(filePath.lastIndexOf('\\')+1));
		//document.getElementById('textfield').append(this.value.slice(this.value.lastIndexOf('\\')+1));
		$("#textfield").val(filePath.slice(filePath.lastIndexOf('\\')+1));
		
		if(IEVersion()==-1){
			fileToBase64(id);
		}else{
			if(IEVersion()>9){
				fileToBase64(id);
			}else{
				fileToBase64_ie(id);
			}
		}
	}
	//选择加密机证书cer
	function selectCerFile(id){
		var filePath=$("#"+id).val();
	//	document.getElementById('cerfield').append(filePath.slice(filePath.lastIndexOf('\\')+1));
		$("#cerfield").val(filePath.slice(filePath.lastIndexOf('\\')+1));
		//document.getElementById('textfield').append(this.value.slice(this.value.lastIndexOf('\\')+1));
		if(IEVersion()==-1){
			fileToBase64(id);
		}else{
			if(IEVersion()>9){
				fileToBase64(id);
			}else{
				fileToBase64_ie(id);
			}
		}
	}
	/**
	*文件转base64(ie9以上)
	*/
	function fileToBase64(id){
		var fileObj = $("#"+id+"")[0].files[0];
		var fileName=$("#"+id+"").val();
		var reader = new FileReader();
		reader.readAsDataURL(fileObj);
		reader.onload = function(theFile) {
			resultStr+=theFile.target.result;
			resultStr=resultStr.slice(resultStr.lastIndexOf(',')+1);	
			return resultStr;//获取文件的base64码
		};
	}
	/**
	*ie9下文件转base64
	*/
	function fileToBase64_ie(id){//路径和文档类型
		/* var file=document.getElementById(id);
		file.select();
		file.blur();
		var filePath = document.selection.createRange().text; */
		var filePath = $("#"+id).val();
		 var realPath, xmlHttp, xml_dom, tmpNode, imgData;
	       	//var testFilePath="C:\\Users\\ThinkPad\\Desktop\\test1.pfx";
	        realPath =filePath;//获取文件的真实本地路径.
	        ////console.log("realPath=-----"+filePath);
	        var reader = new ActiveXObject("ADODB.Stream");
	        reader.charset = "UTF-8";
	        reader.Type=1;
	        reader.Open();
	        reader.LoadFromFile(realPath);
	      	var fileText="";
	   	　    while(!reader.EOS){//是否结束
	   	　　		fileText=reader.Read();
	   	　　}
	        reader.Close();
	        xml_dom = new ActiveXObject("MSXML2.DOMDocument");
	        tmpNode = xml_dom.createElement("tmpNode");
	        tmpNode.dataType = "bin.base64";
	        tmpNode.nodeTypedValue = fileText;
	        resultStr=tmpNode.text.replace(/\n/g,"");
	    //    //console.log("ie8");
	    //    //console.log(resultStr);
	        
	        return resultStr;
	}
	/**
	*判断游览器版本
	*/
	 function IEVersion() {
         var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串  
         var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1; //判断是否IE<11浏览器  
         var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; //判断是否IE的Edge浏览器  
         var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
         if(isIE) {
             var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
             reIE.test(userAgent);
             var fIEVersion = parseFloat(RegExp["$1"]);
             if(fIEVersion == 7) {
                 return 7;
             } else if(fIEVersion == 8) {
                 return 8;
             } else if(fIEVersion == 9) {
                 return 9;
             } else if(fIEVersion == 10) {
                 return 10;
             } else {
                 return 6;//IE版本<=7
             }   
         } else if(isEdge) {
             return -1;//edge
         } else if(isIE11) {
             return 11; //IE11  
         }else{
             return -1;//不是ie浏览器
         }
	}
	function getData(){
		/* var ss="eewr";
		ss.slice(start, end) */
		////console.log( $("#certForm").validate('submitValidate'));
		////console.log(222);
		
	/* 	return; */
		if($("#certForm").validate('submitValidate')){
		//	//console.log("zhengshu")
			var data={};
			data['name']=$("#certname").val();
			data['pwd']=$("#pwd").val();
			data['type']=$("#type").val();
			if($("#type").val()==0){
				var baseCode=resultStr;
				//alert(baseCode);
				//baseCode=baseCode.slice(baseCode.lastIndexOf(',')+1);
				data['pfxContent']=baseCode;
				
			}
			if($("#type").val()==1){
				var baseCode=resultStr;
				data['pfxContent']=baseCode;
				
			}
			data['dn']=null;
			data['encryptionType']=$("#encryptionType").val();
			
			var certArr=new Array();
			certArr.push(data);
			var res=JSON.stringify(certArr);
		//	//console.log(res);
			return res;
		}else{
			return null;
		}
		
	}
	
	//jiaoyan
	 $('#certForm').validate({

    onFocus: function() {

      this.parent().addClass('active');

      return false;

    },

    onBlur: function() {

      var $parent = this.parent();

      var _status = parseInt(this.attr('data-status'));

      $parent.removeClass('active');

      if (!_status) {

        $parent.addClass('error');

      }

      return false;

    }

  });



  $('#certForm').on('submit', function(event) {

    event.preventDefault();

    $(this).validate('submitValidate'); //return boolean;

  });

</script>
</html>